# 作战策略系统设计

> 📌 **设计理念**: 易于上手，深度足够，可通过数据验证效果

---

## 📋 设计概览

### 核心原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          策略配置理念                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   设计原则:                                                                  │
│   ├─ 易于上手: 新手可以用默认策略                                             │
│   ├─ 深度足够: 高手可以精细调优                                               │
│   ├─ 可验证性: 每个策略都能看到数据效果                                        │
│   └─ 无绝对最优: 不同情况需要不同策略                                          │
│                                                                             │
│   策略组成:                                                                  │
│   ├─ 技能优先级: 拖拽排序，决定技能使用顺序                                    │
│   ├─ 条件规则: IF-THEN逻辑，触发特殊行为                                      │
│   ├─ 目标选择: 攻击/治疗目标的选择策略                                        │
│   └─ 资源管理: 资源阈值和保留技能设置                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 条件规则系统

### 条件类型总览

#### 自身状态条件

| 条件类型 | 标识符 | 运算符 | 值类型 | 示例 |
|---------|--------|--------|--------|------|
| 自身HP百分比 | `self_hp_percent` | `<`, `>`, `<=`, `>=`, `=` | 0-100 | 自身HP < 30% |
| 自身资源百分比 | `self_resource_percent` | `<`, `>`, `<=`, `>=`, `=` | 0-100 | 怒气 > 80% |
| 自身资源值 | `self_resource` | `<`, `>`, `<=`, `>=`, `=` | 数值 | 怒气 >= 25 |
| 自身有Buff | `self_has_buff` | `=`, `!=` | buff_id | 有战斗怒吼 |
| 自身无Buff | `self_missing_buff` | `=` | buff_id | 无战斗怒吼 |

#### 敌人状态条件

| 条件类型 | 标识符 | 运算符 | 值类型 | 示例 |
|---------|--------|--------|--------|------|
| 存活敌人数量 | `alive_enemy_count` | `<`, `>`, `<=`, `>=`, `=` | 数值 | 敌人数 >= 3 |
| 目标HP百分比 | `target_hp_percent` | `<`, `>`, `<=`, `>=`, `=` | 0-100 | 目标HP < 20% |
| 最低敌人HP | `lowest_enemy_hp_percent` | `<`, `>` | 0-100 | 最低HP < 15% |
| 最高敌人HP | `highest_enemy_hp_percent` | `<`, `>` | 0-100 | 最高HP > 50% |
| 敌人总HP百分比 | `total_enemy_hp_percent` | `<`, `>` | 0-100 | 总HP < 30% |
| 敌人有Debuff | `enemy_has_debuff` | `=`, `!=` | debuff_id | 敌人有撕裂 |

#### 队友状态条件

| 条件类型 | 标识符 | 运算符 | 值类型 | 示例 |
|---------|--------|--------|--------|------|
| 存活队友数量 | `alive_ally_count` | `<`, `>`, `<=`, `>=`, `=` | 数值 | 队友 <= 2 |
| 任意队友HP | `any_ally_hp_percent` | `<`, `>` | 0-100 | 任意队友HP < 40% |
| 最低队友HP | `lowest_ally_hp_percent` | `<`, `>` | 0-100 | 最低队友HP < 30% |

#### 战斗状态条件

| 条件类型 | 标识符 | 运算符 | 值类型 | 示例 |
|---------|--------|--------|--------|------|
| 战斗回合数 | `battle_round` | `<`, `>`, `<=`, `>=`, `=` | 数值 | 回合 = 1 (开场) |
| 技能可用 | `skill_ready` | `=` | skill_id | 冲锋可用 |
| 技能冷却中 | `skill_on_cooldown` | `=` | skill_id | 盾墙冷却中 |
| 始终 | `always` | - | - | 始终触发 |

### 条件使用示例

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  【条件规则示例】                                                           ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  📌 AOE技能判断                                                            ║
║  ├─ IF 存活敌人 >= 3 THEN 优先使用 [旋风斩]                                ║
║  ├─ IF 存活敌人 >= 2 THEN 优先使用 [顺劈斩]                                ║
║  └─ IF 存活敌人 = 1 THEN 优先使用 [重击]                                   ║
║                                                                           ║
║  📌 斩杀判断（避免浪费大招）                                                 ║
║  ├─ IF 目标HP < 10% THEN 使用 [普通攻击] (节省资源)                        ║
║  ├─ IF 目标HP < 20% AND 目标HP >= 10% THEN 使用 [斩杀]                     ║
║  └─ IF 目标HP >= 20% THEN 使用 [重击]                                      ║
║                                                                           ║
║  📌 生存判断                                                               ║
║  ├─ IF 自身HP < 30% THEN 优先使用 [盾墙]                                   ║
║  ├─ IF 自身HP < 50% AND 盾墙冷却中 THEN 优先使用 [盾牌格挡]                 ║
║  └─ IF 自身HP < 20% THEN 优先使用 [破釜沉舟]                               ║
║                                                                           ║
║  📌 开场技能                                                               ║
║  ├─ IF 回合 = 1 THEN 使用 [冲锋]                                           ║
║  └─ IF 回合 <= 2 AND 无战斗怒吼 THEN 使用 [战斗怒吼]                        ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 🎯 目标选择系统

### 基础目标选择策略

| 策略 | 标识符 | 说明 | 适用场景 |
|-----|--------|------|---------|
| 血量最低 | `lowest_hp` | 攻击HP百分比最低的敌人 | 快速击杀、收割残血 |
| 血量最高 | `highest_hp` | 攻击HP百分比最高的敌人 | 集火肉盾、稳定输出 |
| 威胁最高 | `highest_threat` | 攻击攻击力最高的敌人 | 优先消除高威胁 |
| 随机 | `random` | 随机选择目标 | 分散伤害 |

### 位置技能目标选择 ⭐

对于**顺劈斩**等位置相关技能（攻击主目标+相邻敌人），需要特殊的目标选择策略：

```
敌人位置示意图:
┌─────────────────────────────────────────┐
│  位置:  1    2    3    4    5           │
│  怪物: [狼] [狼] [狼] [狼] [狼]          │
│                                         │
│  顺劈斩目标选择:                          │
│  ├─ 选位置1: 攻击 1,2     (2个目标)      │
│  ├─ 选位置2: 攻击 1,2,3   (3个目标) ✓    │
│  ├─ 选位置3: 攻击 2,3,4   (3个目标) ✓    │
│  ├─ 选位置4: 攻击 3,4,5   (3个目标) ✓    │
│  └─ 选位置5: 攻击 4,5     (2个目标)      │
└─────────────────────────────────────────┘
```

#### 位置目标选择策略

| 策略 | 标识符 | 说明 | 适用技能 |
|-----|--------|------|---------|
| 最大波及数 | `max_adjacent` | 选择能波及最多敌人的位置 | 顺劈斩 |
| 最大波及伤害 | `max_splash_damage` | 选择波及总HP最高的位置 | 顺劈斩（伤害最大化） |
| 中间位置 | `center_position` | 选择位置居中的敌人 | 简单位置策略 |

#### 智能目标选择（推荐方案）

系统根据**技能标签**自动选择最优目标，无需玩家手动配置：

| 技能标签 | 目标选择逻辑 |
|---------|-------------|
| `single` | 使用玩家设置的默认目标策略 |
| `aoe` | 目标选择无影响（攻击所有敌人） |
| `positional` | 自动选择波及敌人最多的位置 |
| `execute` | 自动选择HP低于阈值的敌人 |
| `heal` | 自动选择HP最低的队友 |

**技能目标选择配置示例：**

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  【目标选择配置】                                                           ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  默认攻击目标: [血量最低 ▼]                                                 ║
║                                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  智能目标选择                                                        │ ║
║  │  [✓] 位置技能自动选择最优位置 (顺劈斩等)                              │ ║
║  │  [✓] 斩杀技能自动选择低血量目标                                       │ ║
║  │  [✓] 治疗技能自动选择低血量队友                                       │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  特定技能目标覆盖（可选）                                             │ ║
║  │  [顺劈斩]  → [最大波及伤害 ▼]                                        │ ║
║  │  [斩杀]    → [血量最低 ▼]                                            │ ║
║  │  + 添加技能目标规则                                                   │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## ⚙️ 技能优先级系统

### 优先级排序

玩家可以通过拖拽排序设置技能使用优先级：

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  【技能优先级】拖拽排序                                                     ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  1. ≡ [冲锋]        - 开场使用，眩晕敌人        CD: 3回合           │ ║
║  │  2. ≡ [旋风斩]      - AOE伤害                  CD: 2回合           │ ║
║  │  3. ≡ [顺劈斩]      - 位置AOE                  CD: 无              │ ║
║  │  4. ≡ [英勇打击]    - 主要输出                  CD: 无              │ ║
║  │  5. ≡ [战斗怒吼]    - 团队增益                  CD: 无              │ ║
║  │  6. ≡ [普通攻击]    - 保底技能                  CD: 无              │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  💡 提示: 条件规则触发的技能会临时提升到最高优先级                           ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 技能选择流程

```
1. 检查条件规则（按优先级顺序）
   └─ 如果有规则触发 → 使用规则指定的技能
   
2. 按技能优先级顺序检查
   └─ 找到第一个满足以下条件的技能:
      ├─ 技能未在冷却中
      ├─ 资源足够使用
      ├─ 不在保留技能列表中（或已满足保留条件）
      └─ 使用该技能

3. 如果没有可用技能
   └─ 使用普通攻击
```

---

## 💰 资源管理系统

### 资源阈值

设置资源（怒气/法力/能量）低于阈值时的行为：

| 设置项 | 说明 | 示例 |
|-------|------|------|
| 资源阈值 | 低于此值时限制技能使用 | 怒气 < 30 时只用普攻 |
| 保留资源 | 始终保留一定资源 | 保留 20 点怒气应急 |

### 保留技能

某些技能设为"保留"，只在特定条件下使用：

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  【资源管理】                                                               ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  资源阈值: [30] 以下时只使用普通攻击积攒资源                                 ║
║                                                                           ║
║  保留技能:                                                                 ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  [✓] 盾墙      - 仅在 自身HP < 30% 时使用                            │ ║
║  │  [✓] 破釜沉舟  - 仅在 自身HP < 20% 时使用                            │ ║
║  │  [ ] 斩杀      - 仅在 目标HP < 20% 时使用                            │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 📦 策略模板

### 预设模板

| 模板 | 适用场景 | 特点 |
|-----|---------|------|
| **激进输出** | 低级区刷怪 | 优先高伤害技能，忽略防御 |
| **稳健生存** | 高级区探索 | HP低时防御优先，保守输出 |
| **AOE清怪** | 多敌人战斗 | 优先AOE技能，敌人少时切单体 |
| **控制优先** | 困难战斗 | 优先使用控制技能 |
| **Boss战** | 单目标 | 保留爆发技能，持续输出 |
| **坦克** | 坦克角色 | 优先嘲讽和减伤技能 |
| **治疗优先** | 牧师/圣骑 | 优先治疗队友 |

### 模板示例：战士-稳健生存

```json
{
  "name": "稳健生存",
  "skill_priority": ["charge", "heroic_strike", "cleave", "battle_shout"],
  "target_priority": "lowest_hp",
  "resource_threshold": 20,
  "reserved_skills": ["shield_wall", "last_stand"],
  "conditional_rules": [
    {
      "priority": 1,
      "condition": {"type": "self_hp_percent", "operator": "<", "value": 20},
      "action": {"type": "use_skill", "skill_id": "last_stand"}
    },
    {
      "priority": 2,
      "condition": {"type": "self_hp_percent", "operator": "<", "value": 30},
      "action": {"type": "use_skill", "skill_id": "shield_wall"}
    },
    {
      "priority": 3,
      "condition": {"type": "alive_enemy_count", "operator": ">=", "value": 3},
      "action": {"type": "use_skill", "skill_id": "whirlwind"}
    },
    {
      "priority": 4,
      "condition": {"type": "target_hp_percent", "operator": "<", "value": 20},
      "action": {"type": "use_skill", "skill_id": "execute"}
    }
  ]
}
```

---

## 🗃️ 数据库设计

### battle_strategies 表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 策略ID |
| character_id | INTEGER | NOT NULL FK | 角色ID |
| name | VARCHAR(32) | NOT NULL | 策略名称 |
| is_active | INTEGER | DEFAULT 0 | 是否当前使用 |
| skill_priority | TEXT | | 技能优先级 (JSON数组) |
| conditional_rules | TEXT | | 条件规则 (JSON数组) |
| target_priority | VARCHAR(32) | DEFAULT 'lowest_hp' | 默认目标选择策略 |
| skill_target_overrides | TEXT | | 技能目标覆盖 (JSON对象) |
| resource_threshold | INTEGER | DEFAULT 0 | 资源阈值 |
| reserved_skills | TEXT | | 保留技能 (JSON数组) |
| auto_target_settings | TEXT | | 智能目标设置 (JSON对象) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | | 更新时间 |

```sql
CREATE TABLE IF NOT EXISTS battle_strategies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    character_id INTEGER NOT NULL,
    name VARCHAR(32) NOT NULL,
    is_active INTEGER DEFAULT 0,
    skill_priority TEXT,
    conditional_rules TEXT,
    target_priority VARCHAR(32) DEFAULT 'lowest_hp',
    skill_target_overrides TEXT,
    resource_threshold INTEGER DEFAULT 0,
    reserved_skills TEXT,
    auto_target_settings TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);

CREATE INDEX idx_battle_strategies_character ON battle_strategies(character_id);
CREATE INDEX idx_battle_strategies_active ON battle_strategies(character_id, is_active);
```

### JSON 字段格式

#### skill_priority (技能优先级)

```json
["charge", "whirlwind", "cleave", "heroic_strike", "battle_shout"]
```

#### conditional_rules (条件规则)

```json
[
  {
    "id": "rule_1",
    "priority": 1,
    "enabled": true,
    "condition": {
      "type": "self_hp_percent",
      "operator": "<",
      "value": 30
    },
    "action": {
      "type": "use_skill",
      "skill_id": "shield_wall"
    }
  },
  {
    "id": "rule_2",
    "priority": 2,
    "enabled": true,
    "condition": {
      "type": "alive_enemy_count",
      "operator": ">=",
      "value": 3
    },
    "action": {
      "type": "use_skill",
      "skill_id": "whirlwind"
    }
  },
  {
    "id": "rule_3",
    "priority": 3,
    "enabled": true,
    "condition": {
      "type": "target_hp_percent",
      "operator": "<",
      "value": 20
    },
    "action": {
      "type": "use_skill",
      "skill_id": "execute"
    }
  },
  {
    "id": "rule_4",
    "priority": 4,
    "enabled": true,
    "condition": {
      "type": "target_hp_percent",
      "operator": "<",
      "value": 10
    },
    "action": {
      "type": "normal_attack",
      "comment": "残血用普攻节省资源"
    }
  }
]
```

#### skill_target_overrides (技能目标覆盖)

```json
{
  "cleave": "max_adjacent",
  "execute": "lowest_hp",
  "whirlwind": null
}
```

#### auto_target_settings (智能目标设置)

```json
{
  "positional_auto_optimize": true,
  "execute_auto_target": true,
  "heal_auto_target": true
}
```

#### reserved_skills (保留技能)

```json
[
  {
    "skill_id": "shield_wall",
    "condition": {"type": "self_hp_percent", "operator": "<", "value": 30}
  },
  {
    "skill_id": "last_stand",
    "condition": {"type": "self_hp_percent", "operator": "<", "value": 20}
  }
]
```

---

## 🔄 策略执行流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          策略执行流程                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 【条件规则检查】                                                          │
│     │                                                                       │
│     ├─ 按优先级遍历所有启用的条件规则                                          │
│     ├─ 评估条件是否满足                                                      │
│     ├─ 如果满足 → 检查动作技能是否可用（资源足够、不在CD）                      │
│     │   ├─ 可用 → 执行该技能，结束流程                                       │
│     │   └─ 不可用 → 继续检查下一条规则                                        │
│     └─ 所有规则都不满足或技能不可用 → 进入步骤2                                │
│                                                                             │
│  2. 【资源阈值检查】                                                          │
│     │                                                                       │
│     ├─ 检查当前资源是否低于阈值                                               │
│     │   ├─ 是 → 使用普通攻击（积攒资源）                                      │
│     │   └─ 否 → 进入步骤3                                                   │
│                                                                             │
│  3. 【技能优先级选择】                                                         │
│     │                                                                       │
│     ├─ 按优先级顺序遍历技能列表                                               │
│     ├─ 检查技能是否可用:                                                     │
│     │   ├─ 不在冷却中                                                       │
│     │   ├─ 资源足够                                                         │
│     │   └─ 不在保留列表中（或保留条件已满足）                                  │
│     ├─ 找到可用技能 → 进入步骤4                                              │
│     └─ 无可用技能 → 使用普通攻击                                             │
│                                                                             │
│  4. 【目标选择】                                                              │
│     │                                                                       │
│     ├─ 检查技能是否有目标覆盖设置                                             │
│     │   ├─ 有 → 使用覆盖设置的目标策略                                       │
│     │   └─ 无 → 检查智能目标设置                                             │
│     ├─ 检查技能标签:                                                         │
│     │   ├─ positional + auto_optimize → 计算最优位置                         │
│     │   ├─ execute + auto_target → 选择低HP目标                              │
│     │   ├─ aoe → 无需选择目标                                                │
│     │   └─ 其他 → 使用默认目标策略                                           │
│     └─ 确定最终目标                                                          │
│                                                                             │
│  5. 【执行技能】                                                              │
│     │                                                                       │
│     └─ 对选定目标释放选定技能                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 策略效果分析

### 策略建议生成

基于战斗数据自动生成优化建议：

| 检测项 | 条件 | 建议 |
|-------|------|------|
| 普攻过多 | 普攻占比 > 30% | 降低资源阈值，增加技能使用 |
| AOE浪费 | 单敌人时用AOE | 添加敌人数量条件规则 |
| 斩杀浪费 | 对高HP敌人用斩杀 | 添加目标HP条件规则 |
| 大招浪费 | 对残血用大招 | 添加残血普攻规则 |
| 治疗不足 | 死亡率 > 20% | 调整生存技能触发条件 |
| 过量治疗 | 治疗效率 < 70% | 提高治疗触发的HP阈值 |
| 控制浪费 | 控制重叠 | 调整控制技能间隔 |
| 资源溢出 | 资源溢出 > 20% | 降低资源阈值 |
| 位置技能效率低 | 顺劈斩平均命中 < 2 | 启用智能位置目标 |

---

## 🎨 UI 设计方案：标签页式

> 📌 **设计理念**: 功能分区清晰，渐进式学习，新手可只用简单功能，高手可深入配置

### 整体布局

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  作战策略 - 战士                                    [模板 ▼] [保存] [重置] ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  策略: [稳健生存 ▼] [✓ 当前使用]                         [新建] [复制] [删除]║
║                                                                           ║
║  ┌──────────┬──────────┬──────────┬──────────┐                           ║
║  │ 条件规则 │ 技能顺序 │ 目标选择 │ 高级设置 │                           ║
║  └──────────┴──────────┴──────────┴──────────┘                           ║
║  ═══════════════════════════════════════════════════════════════════════ ║
║                                                                           ║
║                        (标签页内容区域)                                    ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 标签页1：条件规则

> 核心功能：IF-THEN 规则，按优先级执行

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  ┌──────────┬──────────┬──────────┬──────────┐                           ║
║  │▶条件规则 │ 技能顺序 │ 目标选择 │ 高级设置 │                           ║
║  └──────────┴──────────┴──────────┴──────────┘                           ║
║  ═══════════════════════════════════════════════════════════════════════ ║
║                                                                           ║
║  💡 条件规则按优先级从上到下执行，满足条件时使用对应技能                     ║
║                                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #1 [✓]                                                    [×]    │ ║
║  │   当 [自身HP ▼] [< ▼] [20] [% ▼]                                    │ ║
║  │   使用 [破釜沉舟 ▼]                                                 │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #2 [✓]                                                    [×]    │ ║
║  │   当 [自身HP ▼] [< ▼] [30] [% ▼]                                    │ ║
║  │   使用 [盾墙 ▼]                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #3 [✓]                                                    [×]    │ ║
║  │   当 [存活敌人 ▼] [>= ▼] [3]                                        │ ║
║  │   使用 [旋风斩 ▼]                                                   │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #4 [✓]                                                    [×]    │ ║
║  │   当 [存活敌人 ▼] [>= ▼] [2]                                        │ ║
║  │   使用 [顺劈斩 ▼]                                                   │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #5 [✓]                                                    [×]    │ ║
║  │   当 [目标HP ▼] [< ▼] [20] [% ▼]                                    │ ║
║  │   使用 [斩杀 ▼]                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │ ≡ #6 [✓]                                                    [×]    │ ║
║  │   当 [目标HP ▼] [< ▼] [10] [% ▼]                                    │ ║
║  │   使用 [普通攻击 ▼]  💡 残血补刀，节省怒气                           │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║                         [+ 添加条件规则]                                  ║
║                                                                           ║
║  ─────────────────────────────────────────────────────────────────────── ║
║  💡 提示: 拖拽 ≡ 可调整优先级 | 取消勾选可临时禁用规则                     ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**条件类型下拉选项：**
- 自身HP、自身资源、自身有Buff、自身无Buff
- 目标HP、存活敌人、最低敌人HP
- 存活队友、最低队友HP、任意队友HP
- 战斗回合、技能可用、始终

### 标签页2：技能顺序

> 无条件触发时的默认技能使用顺序

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  ┌──────────┬──────────┬──────────┬──────────┐                           ║
║  │ 条件规则 │▶技能顺序 │ 目标选择 │ 高级设置 │                           ║
║  └──────────┴──────────┴──────────┴──────────┘                           ║
║  ═══════════════════════════════════════════════════════════════════════ ║
║                                                                           ║
║  💡 当没有条件规则触发时，按以下顺序选择可用技能                            ║
║                                                                           ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                     │ ║
║  │  优先级   技能名称        资源消耗      冷却      标签               │ ║
║  │  ─────────────────────────────────────────────────────────────────  │ ║
║  │  ≡  1    [冲锋]          怒气 +15     3回合    眩晕 起手           │ ║
║  │  ≡  2    [英勇打击]      怒气 -15     无       单体 高仇恨         │ ║
║  │  ≡  3    [顺劈斩]        怒气 -20     无       位置AOE            │ ║
║  │  ≡  4    [旋风斩]        怒气 -25     2回合    全体AOE            │ ║
║  │  ≡  5    [战斗怒吼]      怒气 -10     无       团队增益            │ ║
║  │  ≡  6    [普通攻击]      怒气 +10     无       基础攻击            │ ║
║  │                                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  ─────────────────────────────────────────────────────────────────────── ║
║  💡 拖拽 ≡ 调整顺序 | 普通攻击建议放最后作为保底                          ║
║                                                                           ║
║  已学技能: 6/22                                [添加技能到列表]           ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 标签页3：目标选择

> 配置攻击/治疗目标的选择策略

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  ┌──────────┬──────────┬──────────┬──────────┐                           ║
║  │ 条件规则 │ 技能顺序 │▶目标选择 │ 高级设置 │                           ║
║  └──────────┴──────────┴──────────┴──────────┘                           ║
║  ═══════════════════════════════════════════════════════════════════════ ║
║                                                                           ║
║  【默认目标策略】                                                          ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                     │ ║
║  │  攻击目标:                                                          │ ║
║  │  ● 血量最低的敌人 (快速击杀)                                         │ ║
║  │  ○ 血量最高的敌人 (集火优先)                                         │ ║
║  │  ○ 攻击力最高的敌人 (消除威胁)                                       │ ║
║  │  ○ 随机选择                                                         │ ║
║  │                                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  【智能目标】                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                     │ ║
║  │  [✓] 位置技能自动优化                                               │ ║
║  │      顺劈斩等技能自动选择能波及最多敌人的位置                         │ ║
║  │                                                                     │ ║
║  │  [✓] 斩杀技能自动找残血                                             │ ║
║  │      斩杀等终结技能自动选择HP低于20%的敌人                           │ ║
║  │                                                                     │ ║
║  │  [✓] 治疗技能自动选低血队友                                         │ ║
║  │      治疗技能自动选择HP最低的队友                                    │ ║
║  │                                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  【特定技能目标覆盖】(可选)                                                 ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  顺劈斩  →  [最大波及伤害 ▼]  (选择总HP最高的相邻组)         [×]    │ ║
║  │  + 为特定技能设置目标策略                                           │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 标签页4：高级设置

> 资源管理、保留技能等高级配置

```
╔═══════════════════════════════════════════════════════════════════════════╗
║  ┌──────────┬──────────┬──────────┬──────────┐                           ║
║  │ 条件规则 │ 技能顺序 │ 目标选择 │▶高级设置 │                           ║
║  └──────────┴──────────┴──────────┴──────────┘                           ║
║  ═══════════════════════════════════════════════════════════════════════ ║
║                                                                           ║
║  【资源管理】                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                     │ ║
║  │  怒气阈值:  [=====●================] 20                             │ ║
║  │                                                                     │ ║
║  │  [✓] 低于阈值时优先使用普通攻击积攒怒气                              │ ║
║  │                                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  【保留技能】                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │                                                                     │ ║
║  │  💡 保留技能只在满足特定条件时才会使用，避免浪费                       │ ║
║  │                                                                     │ ║
║  │  ┌─────────────────────────────────────────────────────────────┐   │ ║
║  │  │ [✓] 盾墙                                                    │   │ ║
║  │  │     仅当 [自身HP ▼] [< ▼] [30] [% ▼] 时使用           [×]  │   │ ║
║  │  └─────────────────────────────────────────────────────────────┘   │ ║
║  │  ┌─────────────────────────────────────────────────────────────┐   │ ║
║  │  │ [✓] 破釜沉舟                                                │   │ ║
║  │  │     仅当 [自身HP ▼] [< ▼] [20] [% ▼] 时使用           [×]  │   │ ║
║  │  └─────────────────────────────────────────────────────────────┘   │ ║
║  │  ┌─────────────────────────────────────────────────────────────┐   │ ║
║  │  │ [✓] 斩杀                                                    │   │ ║
║  │  │     仅当 [目标HP ▼] [< ▼] [20] [% ▼] 时使用           [×]  │   │ ║
║  │  └─────────────────────────────────────────────────────────────┘   │ ║
║  │                                                                     │ ║
║  │  [+ 添加保留技能]                                                   │ ║
║  │                                                                     │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
║  【其他设置】                                                              ║
║  ┌─────────────────────────────────────────────────────────────────────┐ ║
║  │  [✓] 战斗开始时自动使用增益技能 (战斗怒吼等)                         │ ║
║  │  [ ] 优先保持DOT/Debuff效果                                         │ ║
║  └─────────────────────────────────────────────────────────────────────┘ ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 🛠️ 前端实现建议

### 推荐技术栈

| 功能 | 推荐方案 | 说明 |
|-----|---------|------|
| **UI框架** | Element Plus 或 Naive UI | Vue 3 生态，组件丰富 |
| **拖拽排序** | `vuedraggable` | 基于 Sortable.js，稳定可靠 |
| **标签页** | `el-tabs` / `n-tabs` | 框架内置组件 |
| **下拉选择** | `el-select` / `n-select` | 支持搜索、分组 |
| **滑块** | `el-slider` / `n-slider` | 资源阈值设置 |
| **开关** | `el-switch` / `n-switch` | 启用/禁用规则 |
| **卡片** | `el-card` / `n-card` | 规则卡片容器 |

### 组件结构建议

```
StrategyEditor/
├── StrategyEditor.vue          # 主容器
├── StrategyHeader.vue          # 顶部：策略选择、模板、保存
├── tabs/
│   ├── ConditionalRules.vue    # 标签1：条件规则
│   ├── SkillPriority.vue       # 标签2：技能顺序
│   ├── TargetSelection.vue     # 标签3：目标选择
│   └── AdvancedSettings.vue    # 标签4：高级设置
├── components/
│   ├── RuleCard.vue            # 单条规则卡片
│   ├── ConditionSelect.vue     # 条件选择器
│   ├── SkillSelect.vue         # 技能选择器
│   └── DraggableList.vue       # 可拖拽列表
└── composables/
    ├── useStrategy.ts          # 策略状态管理
    └── useConditions.ts        # 条件类型配置
```

### 关键交互

| 交互 | 实现方式 |
|-----|---------|
| 规则拖拽排序 | `vuedraggable` + handle 模式 |
| 规则启用/禁用 | 勾选框，实时更新 |
| 规则删除 | 确认弹窗，防误删 |
| 添加规则 | 底部按钮，新建空规则卡片 |
| 条件/技能选择 | 下拉选择器，支持搜索 |
| 保存策略 | 防抖，自动保存或手动保存 |
| 模板应用 | 确认弹窗，覆盖当前配置 |

---

## ❓ 待讨论问题

1. **复合条件**:
   - 是否支持 AND/OR 组合条件？（如：自身HP < 30% AND 盾墙可用）
   - 还是保持简单，每条规则只有一个条件？

2. **敌人位置系统**:
   - 当前战斗系统是否已有敌人位置概念？
   - 如果没有，需要添加位置系统支持顺劈斩等技能

3. **策略数量限制**:
   - 每个角色可以保存多少套策略？（建议：3-5套）
   - 是否支持策略快速切换？

4. **默认策略**:
   - 新角色是否自动创建默认策略？
   - 默认策略的内容如何定义？

5. **策略同步**:
   - 策略修改是否需要在战斗中生效？
   - 还是只在下一场战斗生效？

---

## 📎 相关文档

- [战士职业技能设计](warrior_skills_design.md)
- [游戏机制设计](game_mechanics.md)
- [数据库设计](database_design.md)

