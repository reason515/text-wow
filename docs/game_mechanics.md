# 游戏机制设计文档

本文档描述适用于所有职业的通用游戏机制。

---

## 📊 属性系统设计

### 升级与属性点分配（新）

- 每次升级获得 **5 点**「可分配属性点」，不再自动增加力量/敏捷/智力/耐力/精神。
- 玩家可在角色面板手动分配到五大主属性，支持多次分配直至点数耗尽。
- 分配后即刻重算派生属性：
  - 物理攻击 = 力量×0.6 + 敏捷×0.2
  - 魔法攻击 = 智力×1.0 + 精神×0.2
  - 物理防御 = 力量×0.2 + 耐力×0.3
  - 魔法防御 = 智力×0.2 + 精神×0.3
  - 物理暴击率 = 5% + 敏捷/20；物理暴击伤害 = 150% + 力量×0.3%
  - 法术暴击率 = 5% + 精神/20；法术暴击伤害 = 150% + 智力×0.3%
  - 闪避率 = 5% + 敏捷/20
- 资源与生命：
  - 升级时回满 HP；非怒气职业回满资源。
  - 怒气职业上限固定 100，升级不回满怒气。
  - 能量职业（盗贼）上限固定 100，升级不增加上限且保持固定值。

### 属性职责总览

| 属性 | 主要作用 | 对应职业 |
|------|---------|---------|
| **力量** | 物理攻击（主）、物理防御（副）、物理暴击伤害 | 战士、圣骑士 |
| **敏捷** | 物理攻击（副）、物理暴击率、闪避 | 盗贼、猎人 |
| **智力** | 魔法攻击（主）、魔法防御（副）、法术暴击伤害 | 法师、术士 |
| **精神** | 魔法攻击（副）、魔法防御（副）、法术暴击率、最大MP、法力回复 | 牧师、治疗职业 |
| **耐力** | 最大HP（主）、物理防御（副） | 所有职业（尤其坦克） |

### 攻击力公式

```
物理攻击 = 力量×0.6 + 敏捷×0.2
魔法攻击 = 智力×1.0 + 精神×0.2
```

**示例：**
- 战士（力量12，敏捷8）：12×0.6 + 8×0.2 = **8.8** 物理攻击
- 法师（智力14，精神10）：14×1.0 + 10×0.2 = **16** 魔法攻击

### 防御力公式

```
物理防御 = 力量×0.2 + 耐力×0.3
魔法防御 = 智力×0.2 + 精神×0.3
```

**示例：**
- 战士（力量12，耐力10）：12×0.2 + 10×0.3 = **5** 物理防御
- 法师（智力14，精神10）：14×0.2 + 10×0.3 = **6** 魔法防御

### HP/MP公式

```
最大HP = 职业基础HP + 耐力×2
最大MP = 职业基础MP + 精神×2（法力职业）
怒气/能量 = 固定值（不受属性影响）
```

**示例：**
- 战士（基础HP 35，耐力10）：35 + 10×2 = **55** HP
- 法师（基础MP 40，精神10）：40 + 10×2 = **60** MP

---

## 💥 暴击系统设计

### 设计原则

暴击系统区分**物理暴击**和**法术暴击**，分别由不同的属性影响：

| 暴击类型 | 影响属性 | 适用场景 |
|---------|---------|---------|
| **物理暴击率** | 敏捷 | 物理攻击、物理技能 |
| **物理暴击伤害** | 力量 | 物理攻击、物理技能 |
| **法术暴击率** | 精神 | 法术攻击、法术技能 |
| **法术暴击伤害** | 智力 | 法术攻击、法术技能 |

### 暴击率公式

```
物理暴击率 = 基础5% + 敏捷/20 + 装备加成 + 被动技能加成 + Buff加成
法术暴击率 = 基础5% + 精神/20 + 装备加成 + 被动技能加成 + Buff加成

暴击率上限：100%
```

**示例计算：**
- 战士（敏捷40）：5% + 40/20 = 5% + 2% = 7% 物理暴击率
- 盗贼（敏捷100）：5% + 100/20 = 5% + 5% = 10% 物理暴击率
- 牧师（精神100）：5% + 100/20 = 5% + 5% = 10% 法术暴击率
- 法师（精神60）：5% + 60/20 = 5% + 3% = 8% 法术暴击率

### 暴击伤害公式

```
物理暴击伤害 = 150% + 力量×0.3% + 装备加成 + 被动技能加成
法术暴击伤害 = 150% + 智力×0.3% + 装备加成 + 被动技能加成

暴击伤害上限：300%
```

**示例计算：**
- 战士（力量100）：150% + 100×0.3% = 150% + 30% = **180%** 暴击伤害
- 盗贼（力量50）：150% + 50×0.3% = 150% + 15% = **165%** 暴击伤害
- 法师（智力150）：150% + 150×0.3% = 150% + 45% = **195%** 法术暴击伤害

### 职业暴击定位

| 职业 | 主属性 | 暴击类型 | 暴击倾向 |
|-----|-------|---------|---------|
| 战士 | 力量 | 物理 | 低暴击率，高暴击伤害 |
| 盗贼 | 敏捷 | 物理 | 高暴击率，中暴击伤害 |
| 猎人 | 敏捷 | 物理 | 高暴击率，中暴击伤害 |
| 法师 | 智力 | 法术 | 中暴击率，高暴击伤害 |
| 术士 | 智力 | 法术 | 中暴击率，中暴击伤害 |
| 牧师 | 智力/精神 | 法术 | 高暴击率（精神高），中暴击伤害 |
| 圣骑士 | 力量/智力 | 混合 | 中暴击率，中暴击伤害 |
| 德鲁伊 | 智力/敏捷 | 混合 | 根据形态变化 |
| 萨满 | 智力/精神 | 法术 | 中暴击率，中暴击伤害 |

### 角色属性字段

```go
type Character struct {
    // ... 其他属性 ...
    
    // 暴击属性（区分物理和法术）
    PhysCritRate    float64 `json:"physCritRate"`    // 物理暴击率
    PhysCritDamage  float64 `json:"physCritDamage"`  // 物理暴击伤害
    SpellCritRate   float64 `json:"spellCritRate"`   // 法术暴击率
    SpellCritDamage float64 `json:"spellCritDamage"` // 法术暴击伤害
}
```

### 战斗系统应用

1. **根据伤害类型选择暴击率**：
   - `damage_type = "physical"` → 使用 `PhysCritRate`
   - `damage_type = "magic/fire/frost/shadow/holy/nature"` → 使用 `SpellCritRate`

2. **暴击判定流程**：
   ```
   1. 获取基础暴击率（根据伤害类型）
   2. 应用被动技能加成
   3. 应用Buff加成
   4. 生成随机数 [0, 1)
   5. 如果随机数 < 实际暴击率，则暴击
   6. 暴击时：最终伤害 = 基础伤害 × 暴击伤害倍率
   ```

---

## ⚡ 闪避系统设计

### 设计原则

闪避系统允许角色和怪物在受到攻击时有机会完全躲避伤害：

| 特性 | 说明 |
|-----|------|
| **基础闪避率** | 5% |
| **影响属性** | 敏捷 |
| **闪避上限** | 50% |
| **适用范围** | 物理攻击和魔法攻击 |

### 闪避率公式

```
闪避率 = 基础5% + 敏捷/20 + 装备加成 + 被动技能加成 + Buff加成

闪避率上限：50%
```

**示例计算：**
- 战士（敏捷8）：5% + 8/20 = 5% + 0.4% = **5.4%** 闪避率
- 盗贼（敏捷100）：5% + 100/20 = 5% + 5% = **10%** 闪避率
- 猎人（敏捷80）：5% + 80/20 = 5% + 4% = **9%** 闪避率

### 职业闪避定位

| 职业 | 敏捷倾向 | 闪避定位 |
|-----|---------|---------|
| 盗贼 | 高 | 高闪避（核心防御手段） |
| 猎人 | 高 | 高闪避 |
| 德鲁伊 | 中 | 中闪避（敏捷形态） |
| 战士 | 低 | 低闪避（依赖护甲） |
| 圣骑士 | 低 | 低闪避（依赖护甲） |
| 法师 | 低 | 低闪避（依赖法术护盾） |
| 术士 | 低 | 低闪避 |
| 牧师 | 中 | 中闪避 |
| 萨满 | 中 | 中闪避 |

### 闪避判定流程

```
1. 攻击者发起攻击
2. 计算防御者的实际闪避率（基础 + 敏捷加成 + 被动 + Buff）
3. 检查技能是否无视闪避（tags 包含 "ignores_dodge"）
4. 如果技能无视闪避，跳过闪避判定
5. 生成随机数 [0, 1)
6. 如果随机数 < 实际闪避率，则闪避成功
7. 闪避成功：攻击完全无效，不造成伤害
8. 闪避失败：正常进行伤害计算
```

### 闪避效果

当闪避成功时：
- 🚫 不造成任何伤害
- 🚫 不触发命中效果（如眩晕、减速等）
- 🚫 不触发攻击者的攻击触发效果（如嗜血回血）
- 🚫 攻击者不获得普通攻击的怒气
- ✅ 技能仍然消耗资源（怒气/法力/能量）
- ✅ 技能仍然进入冷却

### 无视闪避的技能

某些技能可以无视闪避，通过在技能的 `tags` 字段中添加 `"ignores_dodge"` 标签实现：

```json
{
  "id": "some_skill",
  "tags": "[\"ignores_dodge\", \"aoe\"]"
}
```

**设计建议**：以下类型的技能可以考虑无视闪避
- 🎯 必中技能（如某些精准打击）
- 💥 AOE 技能的部分效果
- ⚡ 魔法类控制技能

### 敌人闪避

怪物也具有闪避能力，机制与玩家角色相同：

- 怪物默认闪避率：5%
- 特殊怪物（如敏捷型怪物）可能有更高的闪避率
- Boss 可能有特殊的闪避机制

### 角色属性字段

```go
type Character struct {
    // ... 其他属性 ...
    DodgeRate float64 `json:"dodgeRate"` // 闪避率
}

type Monster struct {
    // ... 其他属性 ...
    DodgeRate float64 `json:"dodgeRate"` // 闪避率
}
```

### 装备词缀（闪避相关）

| 词缀 | 效果 | 适用装备 |
|-----|------|---------|
| of 敏捷 | +5-15 敏捷（间接增加闪避） | 护甲/饰品 |
| of 闪避 | +2-5% 闪避率 | 护甲/饰品 |
| of 灵巧 | +3-8% 闪避率 | 皮甲 |

---

## 🛡️ 伤害计算系统

### 伤害公式

```
基础伤害 = 攻击力 × 技能系数
减伤后伤害 = 基础伤害 × (1 - 防御减伤)
最终伤害 = 减伤后伤害 × (暴击? 暴击伤害倍率 : 1)
```

### 防御减伤公式

```
物理减伤 = 物理防御 / (物理防御 + 100)
魔法减伤 = 魔法防御 / (魔法防御 + 100)

减伤上限：75%
```

**示例：**
- 物理防御100：100/(100+100) = 50% 减伤
- 魔法防御50：50/(50+100) = 33% 减伤

---

## 🎯 仇恨系统

### 基本原理

仇恨值决定怪物攻击目标，仇恨最高的玩家成为攻击目标。

### 仇恨获取

```
基础仇恨 = 伤害量 × 仇恨系数
治疗仇恨 = 治疗量 × 0.5（分摊给所有敌人）
```

### 仇恨系数

| 技能类型 | 系数 | 说明 |
|---------|------|------|
| 普通攻击 | 1.0 | 基础仇恨 |
| 坦克技能 | 1.2-3.0 | 高仇恨 |
| DPS技能 | 0.8-1.0 | 中等仇恨 |
| 治疗技能 | 0.5 | 低仇恨 |
| 嘲讽 | 特殊 | 强制成为第一仇恨 |

---

## 📦 装备系统

### 装备词缀（暴击相关）

| 词缀 | 效果 | 适用装备 |
|-----|------|---------|
| of 暴击 | +3-8% 物理暴击率 | 武器 |
| of 致命 | +10-25% 暴击伤害 | 武器 |
| of 法术暴击 | +3-8% 法术暴击率 | 武器/饰品 |
| of 法术致命 | +10-25% 法术暴击伤害 | 武器/饰品 |

---

## 🔄 回合制战斗

### 战斗流程

1. **玩家回合**：选择技能/攻击
2. **闪避判定**：检查敌人是否闪避（如闪避则跳过伤害）
3. **技能执行**：计算伤害、应用效果
4. **敌人回合**：根据仇恨选择目标
5. **闪避判定**：检查玩家是否闪避敌人攻击
6. **回合结束**：Buff/Debuff 倒计时、DOT伤害

### 资源系统

| 资源类型 | 获取方式 | 消耗方式 |
|---------|---------|---------|
| 怒气 | 攻击/受击获得 | 技能消耗 |
| 法力 | 回合恢复 | 技能消耗 |
| 能量 | 回合恢复（快） | 技能消耗 |

