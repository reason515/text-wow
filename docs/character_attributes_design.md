# 📊 角色属性系统设计文档

> 📌 **核心设计理念**: 角色属性是游戏的核心数值系统，通过五大主属性（力量、敏捷、智力、耐力、精神）影响角色的所有战斗能力

> 📌 **说明**: 本文档描述角色属性系统设计。详细的数值计算公式请参考 [数值计算系统设计](./calculator_design.md)，系统架构请参考 [系统架构文档](./architecture.md)

---

## 📋 目录

1. [属性系统概览](#属性系统概览)
2. [五大主属性](#五大主属性)
3. [属性点分配系统](#属性点分配系统)
4. [属性转换公式](#属性转换公式)
5. [装备属性加成](#装备属性加成)
6. [种族属性加成](#种族属性加成)
7. [暴击系统](#暴击系统)
8. [闪避系统](#闪避系统)
9. [伤害计算系统](#伤害计算系统)
10. [职业属性优先级](#职业属性优先级)

---

## 属性系统概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          角色属性系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   五大主属性:                                                                │
│   💪 力量 (Strength)    → 物理攻击、物理暴击伤害                             │
│   🏃 敏捷 (Agility)     → 物理攻击(副)、物理暴击率、闪避率                   │
│   🧠 智力 (Intellect)   → 法术攻击、法术暴击伤害                             │
│   ❤️ 耐力 (Stamina)     → 最大生命值                                         │
│   ✨ 精神 (Spirit)      → 法术攻击(副)、法术暴击率、最大法力、法力回复      │
│                                                                             │
│   属性来源:                                                                  │
│   ├─ 职业基础属性                                                           │
│   ├─ 等级成长                                                               │
│   ├─ 属性点分配（每级5点）                                                  │
│   ├─ 种族加成（基础值+百分比）                                              │
│   └─ 装备加成                                                               │
│                                                                             │
│   派生属性:                                                                  │
│   ├─ 生命值 (HP)                                                            │
│   ├─ 法力值 (MP)                                                            │
│   ├─ 物理攻击力                                                             │
│   ├─ 法术攻击力                                                             │
│   ├─ 暴击率（物理/法术）                                                     │
│   ├─ 暴击伤害（物理/法术）                                                   │
│   └─ 闪避率                                                                 │
│                                                                             │
│   防御属性（仅由装备提供）:                                                  │
│   ├─ 物理防御（装备）                                                        │
│   └─ 魔法防御（装备）                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五大主属性

### 属性职责总览

| 属性 | 英文 | 图标 | 主要作用 | 次要作用 | 对应职业 |
|-----|------|-----|---------|---------|---------|
| **力量** | Strength | 💪 | 物理攻击力 | 物理暴击伤害加成 | 战士、圣骑士 |
| **敏捷** | Agility | 🏃 | 物理暴击率、闪避率 | 物理攻击(副)、护甲值 | 盗贼、猎人 |
| **智力** | Intellect | 🧠 | 法术攻击力、最大法力 | 法术暴击率 | 法师、术士 |
| **耐力** | Stamina | ❤️ | 最大生命值 | 护甲值 | 所有职业（尤其坦克） |
| **精神** | Spirit | ✨ | 法力回复、生命回复 | 治疗效果加成 | 牧师、治疗职业 |

### 属性详细说明

#### 💪 力量 (Strength)

**主要作用：**
- 物理攻击力：每点力量提供 0.4 物理攻击力
- 物理暴击伤害：每点力量提供 0.3% 物理暴击伤害加成

**适用职业：**
- 战士：核心属性，优先提升
- 圣骑士：重要属性，平衡力量和耐力

#### 🏃 敏捷 (Agility)

**主要作用：**
- 物理攻击力：每点敏捷提供 0.2 物理攻击力（副属性）
- 物理暴击率：每 20 点敏捷提供 1% 物理暴击率
- 闪避率：每 20 点敏捷提供 1% 闪避率
- 护甲值：每点敏捷提供 0.3 护甲值

**适用职业：**
- 盗贼：核心属性，追求高暴击和高闪避
- 猎人：重要属性，提升输出和生存

#### 🧠 智力 (Intellect)

**主要作用：**
- 法术攻击力：每点智力提供 1.0 法术攻击力
- 法术暴击伤害：每点智力提供 0.3% 法术暴击伤害加成

**适用职业：**
- 法师：核心属性，最大化输出
- 术士：核心属性，平衡智力和耐力
- 牧师：重要属性，提升治疗量

#### ❤️ 耐力 (Stamina)

**主要作用：**
- 最大生命值：每点耐力提供 2 最大生命值
- 护甲值：每点耐力提供 0.5 护甲值

**适用职业：**
- 所有职业：基础生存属性
- 坦克职业（战士、圣骑士）：优先提升

#### ✨ 精神 (Spirit)

**主要作用：**
- 法术攻击力：每点精神提供 0.2 法术攻击力（副属性）
- 最大法力：每点精神提供 2 最大法力（仅法力职业）
- 法术暴击率：每 20 点精神提供 1% 法术暴击率
- 法力回复：影响战斗中每回合的法力恢复量
- 生命回复：影响战斗中每回合的生命恢复量

**适用职业：**
- 牧师：核心属性，提升续航和治疗量
- 德鲁伊：重要属性，平衡发展
- 萨满：重要属性，团队支援

---

## 属性点分配系统

### 升级与属性点分配

- 每次升级获得 **5 点**「可分配属性点」，不再自动增加力量/敏捷/智力/耐力/精神
- 玩家可在角色面板手动分配到五大主属性，支持多次分配直至点数耗尽
- 分配后即刻重算派生属性：
  - 物理攻击 = 力量×0.4 + 敏捷×0.2
  - 魔法攻击 = 智力×1.0 + 精神×0.2
  - 物理防御 = 装备物理防御
  - 魔法防御 = 装备魔法防御
  - 物理暴击率 = 5% + 敏捷/20；物理暴击伤害 = 150% + 力量×0.3%
  - 法术暴击率 = 5% + 精神/20；法术暴击伤害 = 150% + 智力×0.3%
  - 闪避率 = 5% + 敏捷/20
- 资源与生命：
  - 升级时回满 HP；非怒气职业回满资源
  - 怒气职业上限固定 100，升级不回满怒气
  - 能量职业（盗贼）上限固定 100，升级不增加上限且保持固定值

### 分配规则

| 规则 | 说明 |
|-----|------|
| 获得方式 | 每升1级获得5点，满级共295点（59级×5点） |
| 分配目标 | 力量/敏捷/智力/耐力/精神 |
| 分配时机 | 升级后可随时分配，无时间限制 |
| 重置机制 | 消耗金币可重置（费用随等级增加） |

### 属性点上限（防止极端堆叠）

| 限制类型 | 数值 | 说明 |
|---------|-----|------|
| 单项软上限 | 40点 | 超过后每点效果减半 |
| 单项硬上限 | 50点 | 无法继续分配 |
| 总分配上限 | 295点 | 等于总升级次数×5 |

### 分配策略示例

```
╔═══════════════════════════════════════════════════════════════════════════╗
║                    30级战士 - 两种培养流派                                  ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║  【输出流】分配145点:                  【坦克流】分配145点:                  ║
║  ├─ 力量: +90 (攻击力优先)            ├─ 力量: +40  (保证基础输出)        ║
║  ├─ 敏捷: +30  (暴击加成)              ├─ 敏捷: +15  (少量闪避)            ║
║  ├─ 智力: +0                          ├─ 智力: +0                        ║
║  ├─ 耐力: +25  (基础生存)              ├─ 耐力: +75 (生存优先)            ║
║  └─ 精神: +0                          └─ 精神: +15  (回复)                ║
║                                                                           ║
║  最终攻击: ~45 (高)                    最终攻击: ~30 (中)                  ║
║  最终HP: ~85 (中)                      最终HP: ~120 (高)                   ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

### 数据库设计

#### character_stat_allocation - 属性分配表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| character_id | INTEGER | PRIMARY KEY FK | 角色ID |
| unspent_points | INTEGER | DEFAULT 0 | 未分配点数 |
| allocated_strength | INTEGER | DEFAULT 0 | 已分配力量 |
| allocated_agility | INTEGER | DEFAULT 0 | 已分配敏捷 |
| allocated_intellect | INTEGER | DEFAULT 0 | 已分配智力 |
| allocated_stamina | INTEGER | DEFAULT 0 | 已分配耐力 |
| allocated_spirit | INTEGER | DEFAULT 0 | 已分配精神 |
| respec_count | INTEGER | DEFAULT 0 | 重置次数 |
| last_respec_at | DATETIME | | 上次重置时间 |

```sql
CREATE TABLE character_stat_allocation (
    character_id INTEGER PRIMARY KEY,
    unspent_points INTEGER DEFAULT 0,
    allocated_strength INTEGER DEFAULT 0,
    allocated_agility INTEGER DEFAULT 0,
    allocated_intellect INTEGER DEFAULT 0,
    allocated_stamina INTEGER DEFAULT 0,
    allocated_spirit INTEGER DEFAULT 0,
    respec_count INTEGER DEFAULT 0,
    last_respec_at DATETIME,
    FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);
```

---

## 属性转换公式

> 💡 以下所有公式均可在游戏内通过 `/help formulas` 命令查询

### 一、生命与能量值

#### 生命值 (HP)

```
最大HP = 职业基础HP + (耐力 × 2) + 装备加成

【职业基础HP示例】
├─ 战士: 35
├─ 圣骑士: 30
├─ 盗贼/猎人: 25
├─ 法师/术士: 20
└─ 牧师/德鲁伊/萨满: 22

示例计算 (1级战士, 基础HP 35, 耐力10):
  基础HP: 35
  耐力加成: 10 × 2 = 20
  总计: 35 + 20 = 55 HP
```

#### 能量值 (资源)

**法力值 Mana** (法师/牧师/术士/德鲁伊/萨满/圣骑士/猎人)
```
最大MP = 职业基础MP + (精神 × 2) + 装备加成

【职业基础MP示例】
├─ 法师: 40
├─ 术士: 35
├─ 牧师: 30
├─ 德鲁伊/萨满: 25
└─ 圣骑士/猎人: 20

示例计算 (1级法师, 基础MP 40, 精神10):
  基础MP: 40
  精神加成: 10 × 2 = 20
  总计: 40 + 20 = 60 MP
```

**怒气 Rage** (战士)
```
最大怒气 = 100 (固定值)
初始怒气 = 0
```

**能量 Energy** (盗贼)
```
最大能量 = 100 (固定值)
初始能量 = 100
```

### 二、攻击力计算

#### 物理攻击力

```
物理攻击 = (力量 × 0.4) + (敏捷 × 0.2) + 武器伤害 + 装备加成

示例 (战士, 力量12, 敏捷8):
  力量加成: 12 × 0.4 = 4.8
  敏捷加成: 8 × 0.2 = 1.6
  基础物理攻击: 4.8 + 1.6 = 6.4
  (加上武器和装备加成后为最终物理攻击)
```

#### 法术攻击力

```
法术攻击 = (智力 × 1.0) + (精神 × 0.2) + 装备加成

示例 (法师, 智力14, 精神10):
  智力加成: 14 × 1.0 = 14
  精神加成: 10 × 0.2 = 2
  基础法术攻击: 14 + 2 = 16
  (加上装备加成后为最终法术攻击)
```

### 三、防御计算

#### 护甲与物理减伤

```
护甲值 = 职业基础护甲 + (耐力 × 0.5) + (敏捷 × 0.3) + 装备护甲

物理减伤% = 护甲 ÷ (护甲 + 400 + 攻击者等级 × 10) × 100%

【护甲减伤上限】75%

示例 (护甲500, 被30级怪物攻击):
  减伤% = 500 ÷ (500 + 400 + 300) = 500 ÷ 1200 = 41.7%
  受到1000物理伤害 → 实际受到 583 点伤害
```

#### 法术抗性

```
法术减伤% = 抗性值 ÷ (抗性值 + 攻击者等级 × 5) × 75%

【法术抗性类型】火焰/冰霜/暗影/自然/奥术/神圣

【种族抗性加成】
├─ 矮人: 冰霜抗性 +15%
├─ 亡灵: 暗影抗性 +15%
└─ 其他种族: 见种族特性表
```

### 四、暴击系统

#### 暴击率计算

```
物理暴击率 = 5% + (敏捷 ÷ 20)% + 装备加成% + 被动技能加成 + Buff加成
法术暴击率 = 5% + (精神 ÷ 20)% + 装备加成% + 被动技能加成 + Buff加成

【暴击率上限】100%

示例 (敏捷100):
  物理暴击率 = 5% + 5% = 10%
```

#### 暴击伤害倍率

```
基础暴击伤害 = 150%

物理暴击伤害 = 150% + (力量 × 0.3%) + 装备加成%
法术暴击伤害 = 150% + (智力 × 0.3%) + 装备加成%

【暴击伤害上限】250%

示例 (力量100):
  物理暴击伤害 = 150% + 30% = 180%
  造成100点基础伤害 → 暴击造成 180 点伤害

示例 (智力150):
  法术暴击伤害 = 150% + 45% = 195%
  造成100点基础伤害 → 暴击造成 195 点伤害
```

### 五、闪避与命中

#### 闪避率

```
闪避率 = 5% + (敏捷 ÷ 20)% + 装备加成% + 种族加成%

【闪避率上限】50%

【种族闪避加成】
└─ 暗夜精灵: +2%

示例 (暗夜精灵, 敏捷100):
  闪避率 = 5% + 5% + 2% = 12%
```

#### 命中率

```
基础命中率 = 95%
等级差修正 = (目标等级 - 自身等级) × 1%
最终命中率 = 95% - 等级差修正 + 装备加成%

【命中率上下限】75% ~ 100%
```

### 六、能量回复机制

#### 法力回复 (Mana)

```
战斗中每回合回复 = 精神 × 职业恢复系数 × 最大MP ÷ 100
战斗外每秒回复 = 战斗中回复 × 3

【职业恢复系数】
├─ 牧师: 0.8%
├─ 德鲁伊: 0.6%
├─ 萨满: 0.6%
├─ 法师: 0.5%
├─ 术士: 0.5%
├─ 圣骑士: 0.4%
└─ 猎人: 0.3%

示例 (牧师, 精神80, 最大MP 500):
  战斗中每回合 = 80 × 0.008 × 500 = 3.2 MP
```

#### 怒气获得 (Rage) - 战士专用

```
【获得怒气】
├─ 普通攻击命中: +5 怒气
├─ 造成暴击: +10 怒气 (额外)
├─ 受到伤害: +(受伤HP ÷ 最大HP × 20) 怒气
└─ 某些技能: +技能定义的怒气值

【怒气衰减】
└─ 脱战后每回合: -5 怒气

示例 (受到200点伤害, 最大HP 1000):
  获得怒气 = 200 ÷ 1000 × 20 = 4 怒气
```

#### 能量恢复 (Energy) - 盗贼专用

```
每回合固定恢复: +20 能量
不会自然衰减
某些技能/天赋可加速恢复
```

#### 生命回复

```
战斗中每回合回复 = 精神 × 0.2
战斗外每秒回复 = 精神 × 1.0 + 最大HP × 1%

【种族加成】
└─ 巨魔: 每回合额外回复 2% 最大HP
```

### 七、技能伤害计算

```
技能伤害 = (技能基础值 + 成长属性 × 成长系数) × 技能等级系数

最终伤害 = 技能伤害 × 暴击倍率 × (1 - 目标减伤%) × 随机波动(±10%)

【技能等级系数】
└─ 等级系数 = 1 + (技能等级 - 1) × 0.1

示例 (5级火球术, 基础50, 智力120, 系数0.8):
  技能伤害 = (50 + 120 × 0.8) × (1 + 0.4) = 146 × 1.4 = 204.4
  暴击造成: 204.4 × 1.5 = 306.6 伤害
```

---

## 装备属性加成

### 在属性计算中的作用

装备加成会直接添加到角色的各项属性中：

#### 生命值 (HP)

```
最大HP = 职业基础HP + (耐力 × 10) + (等级 × HP成长) + 装备加成
```

#### 法力值 (MP)

```
最大MP = 职业基础MP + (智力 × 5) + (等级 × MP成长) + 装备加成
```

#### 物理攻击力

```
物理攻击 = 基础攻击 + (力量 × 2.0) + (敏捷 × 0.5) + 武器伤害 + 装备加成
```

#### 法术攻击力

```
法术攻击 = 基础法伤 + (智力 × 1.5) + 装备加成
```

#### 物理防御

```
物理防御 = 装备物理防御

说明：
- 物理防御完全由装备提供
- 属性点不再影响物理防御值
- 通过装备词缀和基础属性获得物理防御加成
```

#### 魔法防御

```
魔法防御 = 装备魔法防御

说明：
- 魔法防御完全由装备提供
- 属性点不再影响魔法防御值
- 通过装备词缀和基础属性获得魔法防御加成
```

**魔法防御的作用：**
- 魔法防御对所有**元素伤害**类型都生效
- 元素伤害类型包括：火焰、冰霜、雷电、暗影、神圣、自然、奥术
- 所有元素伤害在计算时都使用目标的**魔法防御**值来减少伤害

#### 元素抗性

> 📌 **说明**：元素抗性目前为设计预留功能，实际伤害计算中元素伤害仅受魔法防御影响。

```
火焰抗性 = 基础抗性(0) + 装备火焰抗性
冰霜抗性 = 基础抗性(0) + 装备冰霜抗性
雷电抗性 = 基础抗性(0) + 装备雷电抗性
暗影抗性 = 基础抗性(0) + 装备暗影抗性
神圣抗性 = 基础抗性(0) + 装备神圣抗性
自然抗性 = 基础抗性(0) + 装备自然抗性
```

**当前实现：**
- 元素伤害使用**魔法防御**进行减伤计算
- 元素抗性词缀可在装备上出现，但当前版本未在伤害计算中应用
- 未来版本可能会实现元素抗性作为额外的减伤层（在魔法防御之后应用）

### 伤害计算

**物理伤害计算：**
```
基础物理伤害 = 物理攻击力 × 技能系数 × (1 + 物理伤害加成%) + 固定物理伤害值
防御后伤害 = max(0, 基础物理伤害 - 物理防御)
最终物理伤害 = 防御后伤害 × (1 - 物理抗性%)
```

**物理伤害加成来源：**
- 装备词缀：
  - **物理伤害+%（百分比）**：作用于基础伤害的百分比加成
  - **物理伤害+（固定数值）**：直接加到基础物理伤害上（不受技能系数影响）
- 技能被动：某些被动技能提供物理伤害加成
- Buff效果：战斗中的增益效果

**物理伤害词缀计算规则：**
1. **固定数值加成（如"物理伤害+2~5"）**：
   - 直接加到基础物理伤害上
   - **不受技能系数影响**（因为是固定值）
   - 仍然受物理防御和物理抗性影响
   ```
   基础物理伤害 = 物理攻击力 × 技能系数 × (1 + 物理伤害加成%) + 固定物理伤害值
   ```

2. **百分比加成（如"物理伤害+15%"）**：
   - 作用于基础伤害的百分比加成
   - 受技能系数影响
   ```
   基础物理伤害 = 物理攻击力 × 技能系数 × (1 + 物理伤害加成%)
   ```

3. **攻击力加成（如"攻击力+5"、"攻击力+20%"）**：
   - **攻击力+（固定数值）**：直接加到角色的物理攻击力属性上，影响所有基于物理攻击力的计算
   - **攻击力+%（百分比）**：百分比加成角色的物理攻击力属性
   ```
   实际物理攻击力 = (基础物理攻击力 + 固定攻击力加成) × (1 + 攻击力加成%)
   ```

4. **技能伤害+%（如"技能伤害+10%"）**：
   - 作用于**最终伤害**的百分比加成（在防御和抗性计算之后）
   - 对所有类型的伤害都生效（物理、元素）
   ```
   最终总伤害 = (最终物理伤害 + 最终元素伤害) × (1 + 技能伤害加成%)
   ```

**元素伤害计算（火焰/冰霜/雷电/暗影/神圣/自然）：**
```
基础元素伤害 = 魔法攻击力 × 技能系数 × (1 + 元素伤害加成%) + 固定元素伤害值
最终元素伤害 = max(1, 基础元素伤害 - 魔法防御)
```

**重要说明：**
- 所有元素伤害类型（火焰、冰霜、雷电、暗影、神圣、自然、奥术）都使用**魔法攻击力**作为基础攻击力
- 所有元素伤害都使用目标的**魔法防御**来减少伤害
- 元素伤害的计算公式与物理伤害类似：`伤害 = 攻击 - 防御`（最低为1）
- 当前版本中，元素抗性词缀尚未在伤害计算中生效

**混合伤害计算（重要）：**
当技能本身是物理伤害，但武器上具有元素伤害加成时，会产生**混合伤害**：
- **物理伤害部分**：按物理伤害计算（使用物理攻击力、物理防御）
- **元素伤害部分**：按元素伤害计算（使用魔法攻击力、魔法防御）
- **最终总伤害** = 最终物理伤害 + 最终元素伤害

**注意：** 当前版本中，混合伤害的元素部分使用魔法攻击力计算，但实际代码中可能根据技能类型决定使用物理还是魔法攻击力。

**元素伤害加成生效规则：**

1. **百分比加成（如"火焰伤害+15%"）**：
   - **技能本身是元素伤害**：元素伤害加成直接作用于技能的基础元素伤害
     ```
     基础元素伤害 = 元素攻击力 × 技能系数 × (1 + 元素伤害加成%)
     ```
   - **技能本身是物理伤害**：元素伤害加成作为额外伤害，基于物理攻击力计算
     ```
     额外元素伤害 = 物理攻击力 × 技能系数 × 元素伤害加成%
     ```

2. **固定数值加成（如"火焰伤害+2~5"）**：
   - **技能本身是元素伤害**：固定数值直接加到基础元素伤害上
     ```
     基础元素伤害 = 元素攻击力 × 技能系数 + 固定元素伤害值
     ```
   - **技能本身是物理伤害**：固定数值作为额外元素伤害（不受技能系数影响）
     ```
     额外元素伤害 = 固定元素伤害值
     ```
   - **注意**：固定数值的元素伤害不受技能系数影响，是直接加成的固定值

3. **百分比和固定数值同时存在**：
   - 先计算百分比加成，再加上固定数值
   - **技能本身是元素伤害**：
     ```
     基础元素伤害 = 元素攻击力 × 技能系数 × (1 + 元素伤害加成%) + 固定元素伤害值
     ```
   - **技能本身是物理伤害**：
     ```
     额外元素伤害 = 物理攻击力 × 技能系数 × 元素伤害加成% + 固定元素伤害值
     ```

**减伤机制：**
- **物理防御**：直接减少物理伤害值（伤害 = 攻击 - 防御，最低为1）
- **魔法防御**：直接减少元素伤害值（伤害 = 攻击 - 防御，最低为1）
- **元素抗性**：当前版本未实现，未来可能作为百分比减伤在魔法防御之后应用

**伤害加成优先级总结：**
1. **攻击力加成**（攻击力+、攻击力+%）：最先计算，影响基础攻击力属性
2. **伤害百分比加成**（物理伤害+%、元素伤害+%）：作用于基础伤害的百分比
3. **固定伤害加成**（物理伤害+、元素伤害+）：直接加到基础伤害上
4. **防御和抗性计算**：在基础伤害计算完成后进行
5. **技能伤害加成**（技能伤害+%）：最后计算，作用于最终总伤害

#### 暴击率

```
物理暴击率 = 5% + (敏捷 ÷ 20)% + 装备加成% + 被动技能加成 + Buff加成
法术暴击率 = 5% + (精神 ÷ 20)% + 装备加成% + 被动技能加成 + Buff加成
```

#### 暴击伤害

```
物理暴击伤害 = 150% + (力量 × 0.3%) + 装备加成%
法术暴击伤害 = 150% + (智力 × 0.3%) + 装备加成%
```

#### 闪避率

```
闪避率 = 5% + (敏捷 ÷ 20)% + 装备加成% + 种族加成%
```

#### 命中率

```
最终命中率 = 95% - 等级差修正 + 装备加成%
```

---

## 种族属性加成

### 属性加成机制

**采用"基础值 + 百分比"混合方案：**

| 组成部分 | 说明 | 示例(兽人力量) |
|---------|------|--------------|
| 基础加成 | 创建角色时一次性加成 | +5点力量 |
| 百分比加成 | 该属性总值的额外加成 | +5%力量 |

**计算公式：**
```
最终属性 = (基础属性 + 职业成长 × 等级 + 装备加成) × (1 + 种族百分比加成)
```

**示例计算（兽人战士 Lv.30）：**
```
基础力量 = 15 (职业基础)
等级成长 = 2 × 30 = 60
种族基础 = +5
装备加成 = +20 (假设)
小计 = 15 + 60 + 5 + 20 = 100

种族百分比 = +5%
最终力量 = 100 × 1.05 = 105

vs 人类战士: 100 × 1.00 = 100 (差5点，约5%)
```

这样设计的好处：
- ✅ 初期差异明显（基础值）
- ✅ 后期仍有意义（百分比）
- ✅ 差距不会过于悬殊（只有5%左右）

### 联盟种族

| 种族 | 属性加成 | 被动特性1 | 被动特性2 |
|-----|---------|---------|---------|
| **人类** | 精神+3, 精神+3% | 💡 适应力：经验获取+10% | 🗡️ 剑术专精：物理伤害+3% |
| **矮人** | 力量+3, 耐力+5% | ❄️ 霜抗：冰霜伤害-15% | 🛡️ 石肤：受到暴击伤害-10% |
| **暗夜精灵** | 敏捷+5, 敏捷+3% | 🌙 暗影之心：伤害+5% | 👁️ 敏锐：闪避率+2% |
| **侏儒** | 智力+5, 智力+5% | ⚡ 灵巧心智：法术暴击+3% | 🔧 工程专精：对机械怪伤害+15% |

### 部落种族

| 种族 | 属性加成 | 被动特性1 | 被动特性2 |
|-----|---------|---------|---------|
| **兽人** | 力量+5, 力量+5% | 💢 嗜血：HP<30%时攻击+15% | 💪 坚韧：眩晕时间-25% |
| **亡灵** | 智力+3, 暗影伤害+5% | 💀 亡者之触：攻击5%几率恐惧 | 🌑 暗影抗性：暗影伤害-15% |
| **牛头人** | 耐力+5, 最大HP+5% | ❤️ 坚忍：防御+3% | 🌿 自然亲和：受到治疗+10% |
| **巨魔** | 敏捷+3, 攻速+5% | 💚 再生：每回合恢复2%HP | 🐾 野兽杀手：野兽伤害+15% |

**种族特性触发机制：**
- 所有特性都是被动效果，无需玩家操作
- 属性加成在计算面板时自动应用
- 战斗特性由战斗引擎自动检测触发

---

## 暴击系统

### 设计原则

暴击系统区分**物理暴击**和**法术暴击**，分别由不同的属性影响：

| 暴击类型 | 影响属性 | 适用场景 |
|---------|---------|---------|
| **物理暴击率** | 敏捷 | 物理攻击、物理技能 |
| **物理暴击伤害** | 力量 | 物理攻击、物理技能 |
| **法术暴击率** | 精神 | 法术攻击、法术技能 |
| **法术暴击伤害** | 智力 | 法术攻击、法术技能 |

### 暴击率公式

```
物理暴击率 = 基础5% + 敏捷/20 + 装备加成 + 被动技能加成 + Buff加成
法术暴击率 = 基础5% + 精神/20 + 装备加成 + 被动技能加成 + Buff加成

暴击率上限：100%
```

**示例计算：**
- 战士（敏捷40）：5% + 40/20 = 5% + 2% = 7% 物理暴击率
- 盗贼（敏捷100）：5% + 100/20 = 5% + 5% = 10% 物理暴击率
- 牧师（精神100）：5% + 100/20 = 5% + 5% = 10% 法术暴击率
- 法师（精神60）：5% + 60/20 = 5% + 3% = 8% 法术暴击率

### 暴击伤害公式

```
物理暴击伤害 = 150% + 力量×0.3% + 装备加成 + 被动技能加成
法术暴击伤害 = 150% + 智力×0.3% + 装备加成 + 被动技能加成

暴击伤害上限：300%
```

**示例计算：**
- 战士（力量100）：150% + 100×0.3% = 150% + 30% = **180%** 暴击伤害
- 盗贼（力量50）：150% + 50×0.3% = 150% + 15% = **165%** 暴击伤害
- 法师（智力150）：150% + 150×0.3% = 150% + 45% = **195%** 法术暴击伤害

### 职业暴击定位

| 职业 | 主属性 | 暴击类型 | 暴击倾向 |
|-----|-------|---------|---------|
| 战士 | 力量 | 物理 | 低暴击率，高暴击伤害 |
| 盗贼 | 敏捷 | 物理 | 高暴击率，中暴击伤害 |
| 猎人 | 敏捷 | 物理 | 高暴击率，中暴击伤害 |
| 法师 | 智力 | 法术 | 中暴击率，高暴击伤害 |
| 术士 | 智力 | 法术 | 中暴击率，中暴击伤害 |
| 牧师 | 智力/精神 | 法术 | 高暴击率（精神高），中暴击伤害 |
| 圣骑士 | 力量/智力 | 混合 | 中暴击率，中暴击伤害 |
| 德鲁伊 | 智力/敏捷 | 混合 | 根据形态变化 |
| 萨满 | 智力/精神 | 法术 | 中暴击率，中暴击伤害 |

---

## 闪避系统

### 设计原则

闪避系统允许角色和怪物在受到攻击时有机会完全躲避伤害：

| 特性 | 说明 |
|-----|------|
| **基础闪避率** | 5% |
| **影响属性** | 敏捷 |
| **闪避上限** | 50% |
| **适用范围** | 物理攻击和魔法攻击 |

### 闪避率公式

```
闪避率 = 基础5% + 敏捷/20 + 装备加成 + 被动技能加成 + Buff加成

闪避率上限：50%
```

**示例计算：**
- 战士（敏捷8）：5% + 8/20 = 5% + 0.4% = **5.4%** 闪避率
- 盗贼（敏捷100）：5% + 100/20 = 5% + 5% = **10%** 闪避率
- 猎人（敏捷80）：5% + 80/20 = 5% + 4% = **9%** 闪避率

### 职业闪避定位

| 职业 | 敏捷倾向 | 闪避定位 |
|-----|---------|---------|
| 盗贼 | 高 | 高闪避（核心防御手段） |
| 猎人 | 高 | 高闪避 |
| 德鲁伊 | 中 | 中闪避（敏捷形态） |
| 战士 | 低 | 低闪避（依赖护甲） |
| 圣骑士 | 低 | 低闪避（依赖护甲） |
| 法师 | 低 | 低闪避（依赖法术护盾） |
| 术士 | 低 | 低闪避 |
| 牧师 | 中 | 中闪避 |
| 萨满 | 中 | 中闪避 |

### 闪避判定流程

```
1. 攻击者发起攻击
2. 计算防御者的实际闪避率（基础 + 敏捷加成 + 被动 + Buff）
3. 检查技能是否无视闪避（tags 包含 "ignores_dodge"）
4. 如果技能无视闪避，跳过闪避判定
5. 生成随机数 [0, 1)
6. 如果随机数 < 实际闪避率，则闪避成功
7. 闪避成功：攻击完全无效，不造成伤害
8. 闪避失败：正常进行伤害计算
```

### 闪避效果

当闪避成功时：
- 🚫 不造成任何伤害
- 🚫 不触发命中效果（如眩晕、减速等）
- 🚫 不触发攻击者的攻击触发效果（如嗜血回血）
- 🚫 攻击者不获得普通攻击的怒气
- ✅ 技能仍然消耗资源（怒气/法力/能量）
- ✅ 技能仍然进入冷却

---

## 伤害计算系统

### 伤害公式

```
基础伤害 = 攻击力 × 技能系数
减伤后伤害 = 基础伤害 × (1 - 防御减伤)
最终伤害 = 减伤后伤害 × (暴击? 暴击伤害倍率 : 1)
```

### 防御减伤公式

```
物理减伤 = 物理防御 / (物理防御 + 100)
魔法减伤 = 魔法防御 / (魔法防御 + 100)

减伤上限：75%
```

**示例：**
- 物理防御100：100/(100+100) = 50% 减伤
- 魔法防御50：50/(50+100) = 33% 减伤

---

## 职业属性优先级

> 💡 培养角色时，根据职业选择优先提升的属性

| 职业 | 主属性 | 次要属性 | 第三属性 | 培养建议 |
|-----|-------|---------|---------|---------|
| **战士** | 💪力量 | ❤️耐力 | 🏃敏捷 | 优先力量提升输出，耐力保证生存 |
| **圣骑士** | 💪力量 | ❤️耐力 | 🧠智力 | 平衡力量和耐力，适量智力保证法术 |
| **猎人** | 🏃敏捷 | ❤️耐力 | 🧠智力 | 敏捷优先，确保暴击和闪避 |
| **盗贼** | 🏃敏捷 | 💪力量 | ❤️耐力 | 全力堆敏捷，追求暴击 |
| **牧师** | 🧠智力 | ✨精神 | ❤️耐力 | 智力提升治疗量，精神保证续航 |
| **法师** | 🧠智力 | ❤️耐力 | ✨精神 | 智力最大化，耐力保证不被秒 |
| **术士** | 🧠智力 | ❤️耐力 | ✨精神 | 同法师，但可更多耐力 |
| **德鲁伊** | 🧠智力 | ✨精神 | ❤️耐力 | 根据形态调整，平衡发展 |
| **萨满** | 🧠智力 | ✨精神 | ❤️耐力 | 智力优先，精神保证团队支援 |

---

## 总结

### 设计亮点

1. **五大主属性系统**: 清晰的主属性职责划分，每个属性都有明确的作用
2. **属性点自由分配**: 每级5点可自由分配，提供丰富的培养路径
3. **种族差异化**: 基础值+百分比加成，初期和后期都有意义
4. **装备属性加成**: 装备是属性提升的重要来源，与属性点分配形成互补
5. **暴击和闪避系统**: 区分物理和法术，由不同属性影响，增加策略深度

### 后续扩展方向

- [ ] 属性重置系统优化
- [ ] 属性上限调整机制
- [ ] 属性成长曲线优化
- [ ] 属性可视化界面
- [ ] 属性对比功能

---

**文档版本**: v1.0  
**最后更新**: 2024年

