# å¼€å‘è§„èŒƒæ–‡æ¡£

> ğŸ“Œ **æ ¸å¿ƒè®¾è®¡ç†å¿µ**: ç»Ÿä¸€çš„ä»£ç ç»„ç»‡ã€å‘½åè§„èŒƒã€æ¥å£è®¾è®¡ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§

---

## ğŸ“‹ ç›®å½•

1. [ä»£ç ç»„ç»‡è§„èŒƒ](#ä»£ç ç»„ç»‡è§„èŒƒ)
2. [å‘½åè§„èŒƒ](#å‘½åè§„èŒƒ)
3. [æ¥å£è®¾è®¡è§„èŒƒ](#æ¥å£è®¾è®¡è§„èŒƒ)
4. [æµ‹è¯•è§„èŒƒ](#æµ‹è¯•è§„èŒƒ)
5. [æäº¤è§„èŒƒ](#æäº¤è§„èŒƒ)

---

## ä»£ç ç»„ç»‡è§„èŒƒ

### ç›®å½•ç»“æ„

```
server/
â”œâ”€â”€ cmd/                    # å‘½ä»¤è¡Œå·¥å…·
â”‚   â”œâ”€â”€ init_database/
â”‚   â”œâ”€â”€ load_skills/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ internal/               # å†…éƒ¨ä»£ç 
â”‚   â”œâ”€â”€ api/               # APIå¤„ç†å™¨
â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database/          # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ game/              # æ¸¸æˆé€»è¾‘
â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ repository/        # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ service/           # ä¸šåŠ¡æœåŠ¡å±‚
â”œâ”€â”€ database/              # æ•°æ®åº“è„šæœ¬
â”‚   â”œâ”€â”€ schema.sql
â”‚   â”œâ”€â”€ seed.sql
â”‚   â””â”€â”€ migrate_*.sql
â”œâ”€â”€ test/                  # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ cases/            # è‡ªç„¶è¯­è¨€æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ runner/           # æµ‹è¯•æ‰§è¡Œå™¨
â”‚   â””â”€â”€ fixtures/         # æµ‹è¯•æ•°æ®
â”œâ”€â”€ main.go               # å…¥å£æ–‡ä»¶
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum
```

### æ¨¡å—ç»„ç»‡

#### 1. æ¸¸æˆé€»è¾‘æ¨¡å— (internal/game/)

```
internal/game/
â”œâ”€â”€ battle_manager.go      # æˆ˜æ–—ç®¡ç†å™¨
â”œâ”€â”€ skill_manager.go       # æŠ€èƒ½ç®¡ç†å™¨
â”œâ”€â”€ equipment_manager.go   # è£…å¤‡ç®¡ç†å™¨
â”œâ”€â”€ team_manager.go        # é˜Ÿä¼ç®¡ç†å™¨
â”œâ”€â”€ monster_manager.go     # æ€ªç‰©ç®¡ç†å™¨
â”œâ”€â”€ calculator.go          # æ•°å€¼è®¡ç®—å™¨
â”œâ”€â”€ buff_manager.go        # Buffç®¡ç†å™¨
â”œâ”€â”€ strategy_executor.go   # ç­–ç•¥æ‰§è¡Œå™¨
â””â”€â”€ battle_stats.go        # æˆ˜æ–—ç»Ÿè®¡
```

#### 2. æ•°æ®è®¿é—®å±‚ (internal/repository/)

```
internal/repository/
â”œâ”€â”€ character_repo.go      # è§’è‰²æ•°æ®è®¿é—®
â”œâ”€â”€ equipment_repo.go      # è£…å¤‡æ•°æ®è®¿é—®
â”œâ”€â”€ battle_repo.go         # æˆ˜æ–—æ•°æ®è®¿é—®
â”œâ”€â”€ skill_repo.go          # æŠ€èƒ½æ•°æ®è®¿é—®
â””â”€â”€ ...
```

#### 3. APIå±‚ (internal/api/)

```
internal/api/
â”œâ”€â”€ handlers.go            # é€šç”¨å¤„ç†å™¨
â”œâ”€â”€ battle_handlers.go     # æˆ˜æ–—ç›¸å…³API
â”œâ”€â”€ character_handlers.go  # è§’è‰²ç›¸å…³API
â”œâ”€â”€ equipment_handlers.go # è£…å¤‡ç›¸å…³API
â””â”€â”€ ...
```

---

## å‘½åè§„èŒƒ

### æ–‡ä»¶å‘½å

#### Goæ–‡ä»¶

- **å°å†™å­—æ¯ + ä¸‹åˆ’çº¿**: `battle_manager.go`
- **æè¿°æ€§å‘½å**: æ–‡ä»¶ååº”è¯¥æ¸…æ¥šæè¿°æ–‡ä»¶å†…å®¹
- **é¿å…ç¼©å†™**: ä½¿ç”¨å®Œæ•´å•è¯ï¼Œå¦‚ `manager` è€Œä¸æ˜¯ `mgr`

#### æµ‹è¯•æ–‡ä»¶

- **æµ‹è¯•æ–‡ä»¶åç¼€**: `_test.go`
- **ç¤ºä¾‹**: `battle_manager_test.go`

#### é…ç½®æ–‡ä»¶

- **YAMLæ–‡ä»¶**: `å°å†™å­—æ¯_ä¸‹åˆ’çº¿.yaml`
- **ç¤ºä¾‹**: `basic_combat.yaml`

### å˜é‡å‘½å

#### Goå˜é‡

- **é©¼å³°å‘½å**: `battleManager`, `characterHP`
- **ç§æœ‰å˜é‡**: å°å†™å¼€å¤´ `battleManager`
- **å…¬å¼€å˜é‡**: å¤§å†™å¼€å¤´ `BattleManager`
- **å¸¸é‡**: å…¨å¤§å†™ `MAX_TEAM_SIZE`

#### æ•°æ®åº“å­—æ®µ

- **è›‡å½¢å‘½å**: `character_id`, `max_hp`
- **å°å†™å­—æ¯ + ä¸‹åˆ’çº¿**

### å‡½æ•°å‘½å

#### Goå‡½æ•°

- **é©¼å³°å‘½å**: `CalculateDamage`, `GetCharacter`
- **åŠ¨è¯å¼€å¤´**: å‡½æ•°ååº”è¯¥ä»¥åŠ¨è¯å¼€å¤´
- **æè¿°æ€§**: å‡½æ•°ååº”è¯¥æ¸…æ¥šæè¿°å‡½æ•°åŠŸèƒ½

#### ç¤ºä¾‹

```go
// å¥½çš„å‘½å
func CalculatePhysicalAttack(char *Character) int
func GetCharacterByID(id int) (*Character, error)
func StartBattle(userID int, zoneID string) error

// ä¸å¥½çš„å‘½å
func Calc(char *Character) int  // ä¸æ¸…æ™°
func Get(id int) (*Character, error)  // ä¸æ˜ç¡®
func Do(userID int) error  // ä¸æè¿°æ€§
```

### ç±»å‹å‘½å

#### Goç±»å‹

- **é©¼å³°å‘½å**: `BattleManager`, `Character`
- **æè¿°æ€§**: ç±»å‹ååº”è¯¥æ¸…æ¥šæè¿°ç±»å‹ç”¨é€”

#### ç¤ºä¾‹

```go
// å¥½çš„å‘½å
type BattleManager struct { ... }
type Character struct { ... }
type DamageCalculator interface { ... }

// ä¸å¥½çš„å‘½å
type BM struct { ... }  // ç¼©å†™
type C struct { ... }   // ä¸æ¸…æ™°
```

---

## æ¥å£è®¾è®¡è§„èŒƒ

### æ¥å£å®šä¹‰

#### 1. å•ä¸€èŒè´£

æ¯ä¸ªæ¥å£åº”è¯¥åªæœ‰ä¸€ä¸ªèŒè´£ã€‚

```go
// å¥½çš„è®¾è®¡
type DamageCalculator interface {
    CalculateDamage(attacker, defender *Character, skill *Skill) int
}

type HealingCalculator interface {
    CalculateHealing(healer, target *Character, skill *Skill) int
}

// ä¸å¥½çš„è®¾è®¡
type Calculator interface {
    CalculateDamage(...) int
    CalculateHealing(...) int
    CalculateDefense(...) int
    // å¤ªå¤šèŒè´£
}
```

#### 2. æ¥å£å‘½å

- **æ¥å£åä»¥ `er` ç»“å°¾**: `Calculator`, `Manager`, `Executor`
- **æè¿°æ€§å‘½å**: æ¥å£ååº”è¯¥æ¸…æ¥šæè¿°æ¥å£ç”¨é€”

#### 3. æ–¹æ³•å‘½å

- **åŠ¨è¯å¼€å¤´**: `Calculate`, `Get`, `Set`, `Start`
- **æè¿°æ€§**: æ–¹æ³•ååº”è¯¥æ¸…æ¥šæè¿°æ–¹æ³•åŠŸèƒ½

### é”™è¯¯å¤„ç†

#### é”™è¯¯è¿”å›

```go
// æ ‡å‡†é”™è¯¯è¿”å›
func GetCharacter(id int) (*Character, error) {
    if id <= 0 {
        return nil, fmt.Errorf("invalid character id: %d", id)
    }
    // ...
    return character, nil
}
```

#### é”™è¯¯ç±»å‹

```go
// å®šä¹‰é”™è¯¯ç±»å‹
var (
    ErrCharacterNotFound = errors.New("character not found")
    ErrInvalidInput      = errors.New("invalid input")
    ErrPermissionDenied  = errors.New("permission denied")
)
```

---

## æµ‹è¯•è§„èŒƒ

### æµ‹è¯•ç”¨ä¾‹ç¼–å†™

#### 1. ä½¿ç”¨è‡ªç„¶è¯­è¨€

æµ‹è¯•ç”¨ä¾‹åº”è¯¥ä½¿ç”¨è‡ªç„¶è¯­è¨€æè¿°ï¼Œæ˜“äºç†è§£ã€‚

```yaml
# å¥½çš„æµ‹è¯•ç”¨ä¾‹
- name: "åŸºç¡€æˆ˜æ–—æµç¨‹æµ‹è¯•"
  description: "æµ‹è¯•ä¸€ä¸ªç®€å•çš„æˆ˜æ–—æµç¨‹ï¼Œè§’è‰²æ”»å‡»æ€ªç‰©ç›´åˆ°ä¸€æ–¹æ­»äº¡"
  setup:
    - "åˆ›å»ºä¸€ä¸ª1çº§äººç±»æˆ˜å£«è§’è‰²ï¼ŒHP=25ï¼Œæ”»å‡»åŠ›=8"
    - "åˆ›å»ºä¸€ä¸ª1çº§æ£®æ—ç‹¼æ€ªç‰©ï¼ŒHP=20ï¼Œæ”»å‡»åŠ›=5"
  steps:
    - action: "å¼€å§‹æˆ˜æ–—"
      expected: "æˆ˜æ–—çŠ¶æ€ä¸ºè¿›è¡Œä¸­"

# ä¸å¥½çš„æµ‹è¯•ç”¨ä¾‹
- name: "test1"
  description: "test"
  setup:
    - "create char"
  steps:
    - action: "start"
      expected: "ok"
```

#### 2. å®Œæ•´è¦†ç›–

æµ‹è¯•ç”¨ä¾‹åº”è¯¥è¦†ç›–ï¼š
- **æ­£å¸¸æƒ…å†µ**: æ ‡å‡†æµç¨‹
- **è¾¹ç•Œæƒ…å†µ**: æœ€å¤§å€¼ã€æœ€å°å€¼ã€ç©ºå€¼
- **å¼‚å¸¸æƒ…å†µ**: é”™è¯¯è¾“å…¥ã€å¼‚å¸¸çŠ¶æ€

#### 3. ç‹¬ç«‹æµ‹è¯•

æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•ç”¨ä¾‹ã€‚

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
test/
â”œâ”€â”€ cases/                 # è‡ªç„¶è¯­è¨€æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ battle/
â”‚   â”œâ”€â”€ skill/
â”‚   â””â”€â”€ equipment/
â”œâ”€â”€ runner/               # æµ‹è¯•æ‰§è¡Œå™¨
â””â”€â”€ fixtures/             # æµ‹è¯•æ•°æ®
```

---

## æäº¤è§„èŒƒ

### æäº¤ä¿¡æ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Typeç±»å‹

- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼è°ƒæ•´
- `refactor`: ä»£ç é‡æ„
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»º/å·¥å…·ç›¸å…³

#### ScopeèŒƒå›´

- `battle`: æˆ˜æ–—ç³»ç»Ÿ
- `skill`: æŠ€èƒ½ç³»ç»Ÿ
- `equipment`: è£…å¤‡ç³»ç»Ÿ
- `team`: é˜Ÿä¼ç³»ç»Ÿ
- `monster`: æ€ªç‰©ç³»ç»Ÿ
- `economy`: ç»æµç³»ç»Ÿ
- `config`: é…ç½®ç³»ç»Ÿ

#### ç¤ºä¾‹

```
feat(battle): æ·»åŠ å¤šè§’è‰²æˆ˜æ–—æ”¯æŒ

- æ”¯æŒæœ€å¤š5ä¸ªè§’è‰²åŒæ—¶æˆ˜æ–—
- æ·»åŠ ä»‡æ¨ç³»ç»Ÿ
- æ·»åŠ é˜Ÿä¼ååŒæŠ€èƒ½

Closes #123
```

```
fix(equipment): ä¿®å¤è£…å¤‡å¼ºåŒ–æ¶ˆè€—è®¡ç®—é”™è¯¯

- ä¿®å¤å¼ºåŒ–ç­‰çº§è®¡ç®—é”™è¯¯
- ä¿®å¤ææ–™æ¶ˆè€—è®¡ç®—é”™è¯¯

Fixes #456
```

```
docs(architecture): æ›´æ–°ç³»ç»Ÿæ¶æ„æ–‡æ¡£

- æ·»åŠ æ€ªç‰©ç³»ç»Ÿè®¾è®¡
- æ›´æ–°ç³»ç»Ÿä¾èµ–å…³ç³»å›¾
- æ·»åŠ é…ç½®åŒ–è®¾è®¡è¯´æ˜
```

### æäº¤é¢‘ç‡

- **å°åŠŸèƒ½**: æ¯ä¸ªåŠŸèƒ½ä¸€ä¸ªæäº¤
- **å¤§åŠŸèƒ½**: åˆ†å¤šä¸ªæäº¤ï¼Œæ¯ä¸ªæäº¤å®Œæˆä¸€ä¸ªå­åŠŸèƒ½
- **é¿å…**: ä¸€æ¬¡æäº¤åŒ…å«å¤šä¸ªä¸ç›¸å…³çš„ä¿®æ”¹

---

## ä»£ç å®¡æŸ¥è§„èŒƒ

### å®¡æŸ¥è¦ç‚¹

1. **ä»£ç è´¨é‡**: ä»£ç æ˜¯å¦æ¸…æ™°ã€å¯è¯»
2. **åŠŸèƒ½æ­£ç¡®æ€§**: åŠŸèƒ½æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
3. **æµ‹è¯•è¦†ç›–**: æ˜¯å¦æœ‰è¶³å¤Ÿçš„æµ‹è¯•è¦†ç›–
4. **æ€§èƒ½è€ƒè™‘**: æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜
5. **å®‰å…¨æ€§**: æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜

### å®¡æŸ¥æµç¨‹

```
1. åˆ›å»ºPull Request
2. è‡ªåŠ¨è¿è¡Œæµ‹è¯•
3. ä»£ç å®¡æŸ¥
4. ä¿®æ”¹ï¼ˆå¦‚éœ€è¦ï¼‰
5. åˆå¹¶
```

---

## æ€»ç»“

### è§„èŒƒè¦ç‚¹

1. **ç»Ÿä¸€çš„ä»£ç ç»„ç»‡**: æ¸…æ™°çš„ç›®å½•ç»“æ„
2. **ä¸€è‡´çš„å‘½åè§„èŒƒ**: æ˜“äºç†è§£å’Œç»´æŠ¤
3. **æ¸…æ™°çš„æ¥å£è®¾è®¡**: å•ä¸€èŒè´£ï¼Œæ˜“äºæ‰©å±•
4. **å®Œå–„çš„æµ‹è¯•è§„èŒƒ**: è‡ªç„¶è¯­è¨€æµ‹è¯•ç”¨ä¾‹
5. **è§„èŒƒçš„æäº¤æµç¨‹**: æ¸…æ™°çš„æäº¤ä¿¡æ¯

### åç»­æ‰©å±•

- [ ] ä»£ç æ ¼å¼åŒ–å·¥å…·é…ç½®
- [ ] é™æ€ä»£ç åˆ†æå·¥å…·
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
- [ ] ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´


