# 数值计算系统设计文档

> 📌 **核心设计理念**: 统一的数值计算逻辑，所有公式集中管理，易于调整和测试

---

## 📋 目录

1. [系统概览](#系统概览)
2. [属性转换公式](#属性转换公式)
3. [伤害计算公式](#伤害计算公式)
4. [防御减伤公式](#防御减伤公式)
5. [暴击系统公式](#暴击系统公式)
6. [闪避系统公式](#闪避系统公式)
7. [治疗计算公式](#治疗计算公式)
8. [资源计算公式](#资源计算公式)

---

## 系统概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数值计算系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入数据 ──→ 计算公式 ──→ 输出结果                                          │
│      │            │            │                                             │
│   角色属性    统一计算器    最终数值                                         │
│   技能数据    公式配置      战斗数据                                         │
│   装备数据    可配置参数                                                     │
│                                                                             │
│   计算模块:                                                                  │
│   ├─ 属性转换: 主属性 → 派生属性                                             │
│   ├─ 伤害计算: 攻击力 → 最终伤害                                             │
│   ├─ 防御计算: 防御力 → 减伤率                                               │
│   ├─ 暴击计算: 暴击率 → 暴击判定                                             │
│   ├─ 闪避计算: 闪避率 → 闪避判定                                             │
│   └─ 治疗计算: 治疗力 → 最终治疗                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 属性转换公式

### 1. 生命值 (HP)

```
最大HP = 职业基础HP + (耐力 × 2) + 装备HP加成

职业基础HP:
├─ 战士: 35
├─ 圣骑士: 30
├─ 盗贼/猎人: 25
├─ 法师/术士: 20
└─ 牧师/德鲁伊/萨满: 22
```

### 2. 能量值 (资源)

#### 法力值 (Mana)

```
最大MP = 职业基础MP + (精神 × 2) + 装备MP加成

职业基础MP:
├─ 法师: 40
├─ 术士: 35
├─ 牧师: 30
├─ 德鲁伊/萨满: 25
└─ 圣骑士/猎人: 20
```

#### 怒气 (Rage)

```
最大怒气 = 100 (固定值)
初始怒气 = 0
```

#### 能量 (Energy)

```
最大能量 = 100 (固定值)
初始能量 = 100
```

### 3. 物理攻击力

```
物理攻击 = (力量 × 0.4) + (敏捷 × 0.2) + 武器伤害 + 装备加成

示例 (战士, 力量12, 敏捷8):
  力量加成: 12 × 0.4 = 4.8
  敏捷加成: 8 × 0.2 = 1.6
  基础物理攻击: 4.8 + 1.6 = 6.4
  (加上武器和装备加成后为最终物理攻击)
```

### 4. 法术攻击力

```
法术攻击 = (智力 × 1.0) + (精神 × 0.2) + 装备加成

示例 (法师, 智力14, 精神10):
  智力加成: 14 × 1.0 = 14
  精神加成: 10 × 0.2 = 2
  基础法术攻击: 14 + 2 = 16
  (加上装备加成后为最终法术攻击)
```

### 5. 物理暴击率

```
物理暴击率 = 5% (基础) + (敏捷 / 20) + 装备加成

示例 (盗贼, 敏捷20):
  基础暴击率: 5%
  敏捷加成: 20 / 20 = 1% (即1%)
  总计: 5% + 1% = 6%
```

### 6. 物理暴击伤害

```
物理暴击伤害 = 150% (基础) + (力量 × 0.3%) + 装备加成

示例 (战士, 力量15):
  基础暴击伤害: 150%
  力量加成: 15 × 0.3% = 4.5%
  总计: 150% + 4.5% = 154.5%
```

### 7. 法术暴击率

```
法术暴击率 = 5% (基础) + (精神 / 20) + 装备加成

示例 (法师, 精神20):
  基础暴击率: 5%
  精神加成: 20 / 20 = 1% (即1%)
  总计: 5% + 1% = 6%
```

### 8. 法术暴击伤害

```
法术暴击伤害 = 150% (基础) + (智力 × 0.3%) + 装备加成

示例 (法师, 智力15):
  基础暴击伤害: 150%
  智力加成: 15 × 0.3% = 4.5%
  总计: 150% + 4.5% = 154.5%
```

### 9. 闪避率

```
闪避率 = 5% (基础) + (敏捷 / 20) + 装备加成

示例 (盗贼, 敏捷20):
  基础闪避率: 5%
  敏捷加成: 20 / 20 = 1% (即1%)
  总计: 5% + 1% = 6%
```

---

## 伤害计算公式

### 基础伤害计算

```
基础伤害 = 攻击力 × 技能系数

技能系数:
├─ 普通攻击: 100%
├─ 基础技能: 100-150%
├─ 强力技能: 150-250%
└─ 终极技能: 250-400%
```

### 完整伤害计算流程

```
1. 基础伤害
   基础伤害 = 攻击力 × 技能系数

2. 防御减伤
   减伤率 = 防御 / (防御 + 100)
   减伤后伤害 = 基础伤害 × (1 - 减伤率)
   减伤上限: 75%

3. 暴击判定
   IF 随机数 < 暴击率 THEN
       最终伤害 = 减伤后伤害 × 暴击伤害倍率
   ELSE
       最终伤害 = 减伤后伤害
   END IF

4. 闪避判定
   IF 随机数 < 闪避率 AND 技能不无视闪避 THEN
       最终伤害 = 0 (闪避)
   END IF

5. 最终伤害
   最终伤害 = max(1, 最终伤害)  // 至少造成1点伤害
```

### 元素伤害计算

```
元素伤害 = 基础伤害 × 元素伤害加成% + 固定元素伤害

元素伤害加成来源:
├─ 装备词缀
├─ 技能效果
└─ Buff效果
```


---

## 防御减伤公式

### 物理防御减伤

```
物理减伤率 = 物理防御 / (物理防御 + 100)

减伤上限: 75%

示例:
├─ 物理防御 10: 10/(10+100) = 9.1% 减伤
├─ 物理防御 50: 50/(50+100) = 33.3% 减伤
├─ 物理防御 100: 100/(100+100) = 50% 减伤
└─ 物理防御 300: min(300/(300+100), 0.75) = 75% 减伤 (上限)
```

### 法术防御减伤

```
法术减伤率 = 法术防御 / (法术防御 + 100)

减伤上限: 75%

示例:
├─ 法术防御 10: 10/(10+100) = 9.1% 减伤
├─ 法术防御 50: 50/(50+100) = 33.3% 减伤
├─ 法术防御 100: 100/(100+100) = 50% 减伤
└─ 法术防御 300: min(300/(300+100), 0.75) = 75% 减伤 (上限)
```

### 元素抗性减伤

```
元素减伤率 = 元素抗性 / (元素抗性 + 100)

减伤上限: 75%

元素类型:
├─ 火焰抗性
├─ 冰霜抗性
├─ 暗影抗性
├─ 神圣抗性
└─ 自然抗性
```

---

## 暴击系统公式

### 暴击判定

```
IF 随机数(0-100) < 暴击率 THEN
    触发暴击
    最终伤害 = 基础伤害 × 暴击伤害倍率
ELSE
    不触发暴击
    最终伤害 = 基础伤害
END IF
```

### 暴击率计算

#### 物理暴击率

```
物理暴击率 = 5% (基础) + (敏捷 / 20) + 装备加成 + Buff加成

上限: 通常为 40-50%
```

#### 法术暴击率

```
法术暴击率 = 5% (基础) + (精神 / 20) + 装备加成 + Buff加成

上限: 通常为 40-50%
```

### 暴击伤害计算

#### 物理暴击伤害

```
物理暴击伤害 = 150% (基础) + (力量 × 0.3%) + 装备加成 + Buff加成

示例 (战士, 力量20, 装备+20%):
  基础: 150%
  力量加成: 20 × 0.3% = 6%
  装备加成: 20%
  总计: 150% + 6% + 20% = 176%
```

#### 法术暴击伤害

```
法术暴击伤害 = 150% (基础) + (智力 × 0.3%) + 装备加成 + Buff加成

示例 (法师, 智力20, 装备+20%):
  基础: 150%
  智力加成: 20 × 0.3% = 6%
  装备加成: 20%
  总计: 150% + 6% + 20% = 176%
```

---

## 闪避系统公式

### 闪避判定

```
IF 随机数(0-100) < 闪避率 AND 技能不无视闪避 THEN
    触发闪避
    最终伤害 = 0
ELSE
    不触发闪避
    正常计算伤害
END IF
```

### 闪避率计算

```
闪避率 = 5% (基础) + (敏捷 / 20) + 装备加成 + Buff加成

上限: 通常为 40-50%

示例 (盗贼, 敏捷30, 装备+5%):
  基础: 5%
  敏捷加成: 30 / 20 = 1.5% (即1.5%)
  装备加成: 5%
  总计: 5% + 1.5% + 5% = 11.5%
```

### 无视闪避

某些技能可以无视闪避，通过在技能的 `tags` 字段中添加 `"ignores_dodge"` 标签实现。

---

## 治疗计算公式

### 基础治疗计算

```
基础治疗 = 治疗力 × 技能系数

治疗力来源:
├─ 智力 (主要)
├─ 精神 (次要)
└─ 装备加成
```

### 完整治疗计算流程

```
1. 基础治疗
   基础治疗 = 治疗力 × 技能系数

2. 治疗加成
   最终治疗 = 基础治疗 × (1 + 治疗加成%)

治疗加成来源:
├─ 装备词缀
├─ 被动技能
└─ Buff效果

3. 过量治疗
   IF 最终治疗 > (最大HP - 当前HP) THEN
       实际治疗 = 最大HP - 当前HP
       过量治疗 = 最终治疗 - 实际治疗
   ELSE
       实际治疗 = 最终治疗
       过量治疗 = 0
   END IF
```

### 持续治疗 (HOT)

```
每回合治疗 = 基础治疗 / 持续回合数

示例 (持续治疗, 基础治疗60, 持续3回合):
  每回合治疗: 60 / 3 = 20
  总治疗: 20 × 3 = 60
```

---

## 资源计算公式

### 资源恢复

#### 法力恢复

```
每回合恢复 = 基础恢复 + (精神 × 0.1) + 装备加成

基础恢复:
├─ 法师: 10-15
├─ 术士: 8-12
├─ 牧师: 12-18
└─ 其他: 5-10
```

#### 怒气获取

```
攻击获得 = 基础获得 + 技能加成
受击获得 = 基础获得 + 技能加成

基础获得:
├─ 攻击: 5-10
└─ 受击: 3-8
```

#### 能量恢复

```
每回合恢复 = 基础恢复 + 装备加成

基础恢复:
└─ 盗贼: 20-30
```

### 资源消耗

```
消耗后资源 = 当前资源 - 技能消耗

资源不足:
IF 当前资源 < 技能消耗 THEN
    无法使用技能
END IF
```

---

## 计算公式配置化

### 配置表设计

```sql
-- 公式配置表
CREATE TABLE game_formulas (
    id VARCHAR(64) PRIMARY KEY,
    category VARCHAR(32) NOT NULL,  -- attribute/combat/skill/resource
    name VARCHAR(64) NOT NULL,  -- 公式名称
    formula TEXT NOT NULL,  -- 公式表达式
    description TEXT,  -- 详细说明
    variables TEXT,  -- 变量说明(JSON)
    example TEXT,  -- 计算示例
    display_order INTEGER DEFAULT 0  -- 显示顺序
);
```

### 公式示例

```json
{
  "id": "physical_attack",
  "category": "attribute",
  "name": "物理攻击力",
  "formula": "(力量 × 0.4) + (敏捷 × 0.2) + 武器伤害 + 装备加成",
  "description": "计算角色的物理攻击力",
  "variables": {
    "力量": "主属性，每点提供0.4物理攻击",
    "敏捷": "主属性，每点提供0.2物理攻击",
    "武器伤害": "武器的基础伤害",
    "装备加成": "装备提供的攻击力加成"
  },
  "example": "力量12, 敏捷8: (12×0.4)+(8×0.2)=6.4"
}
```

---

## 计算器接口设计

### 属性计算接口

```go
type AttributeCalculator interface {
    // 计算物理攻击力
    CalculatePhysicalAttack(char *Character) int
    
    // 计算法术攻击力
    CalculateMagicAttack(char *Character) int
    
    // 计算防御力
    CalculateDefense(char *Character) (physical, magic int)
    
    // 计算生命值
    CalculateHP(char *Character) int
    
    // 计算法力值
    CalculateMP(char *Character) int
    
    // 计算暴击率
    CalculateCritRate(char *Character, isPhysical bool) float64
    
    // 计算暴击伤害
    CalculateCritDamage(char *Character, isPhysical bool) float64
    
    // 计算闪避率
    CalculateDodgeRate(char *Character) float64
}
```

### 伤害计算接口

```go
type DamageCalculator interface {
    // 计算伤害
    CalculateDamage(attacker, defender *Character, skill *Skill) int
    
    // 计算治疗
    CalculateHealing(healer, target *Character, skill *Skill) int
    
    // 计算暴击伤害
    CalculateCritDamage(baseDamage int, critDamage float64) int
    
    // 计算闪避
    ShouldDodge(attacker, defender *Character, skill *Skill) bool
    
    // 计算防御减伤
    CalculateDefenseReduction(damage int, defense int, isPhysical bool) int
}
```

---

## 总结

### 设计亮点

1. **统一的计算公式**: 所有计算逻辑集中管理
2. **清晰的公式定义**: 每个公式都有明确的说明和示例
3. **配置化设计**: 公式可以通过配置表调整
4. **易于测试**: 纯函数设计，易于单元测试

### 后续扩展

- [ ] 公式可视化工具
- [ ] 公式平衡性分析工具
- [ ] 公式版本管理
- [ ] 公式性能优化

---

**文档版本**: v1.0  
**最后更新**: 2025年


