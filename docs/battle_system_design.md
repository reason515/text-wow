# 战斗系统设计文档

> 📌 **核心设计理念**: 支持单角色和多角色小队战斗，清晰的回合机制，精确的伤害计算，公平的胜负判定

---

## 📋 目录

1. [系统概览](#系统概览)
2. [战斗流程设计](#战斗流程)
3. [单角色战斗](#单角色战斗)
4. [多角色战斗](#多角色战斗)
5. [回合机制](#回合机制)
6. [伤害计算](#伤害计算)
7. [胜负判定](#胜负判定)
8. [战斗日志](#战斗日志)

---

## 系统概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          战斗系统架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   战斗初始化 ──→ 回合循环 ──→ 伤害计算 ──→ 胜负判定 ──→ 奖励结算            │
│      │             │            │            │            │                │
│   加载角色     玩家行动     使用计算器    检查状态    经验/金币/掉落         │
│   生成怪物     敌人行动     应用效果      更新数据    统计记录               │
│                                                                             │
│   支持模式:                                                                  │
│   ├─ 单角色战斗: 1个角色 vs 1个或多个怪物                                  │
│   └─ 多角色战斗: 最多5个角色 vs 1个或多个怪物                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 战斗流程

### 完整战斗流程

```
1. 战斗初始化
   ├─ 加载角色数据（单角色或队伍）
   ├─ 生成怪物（根据区域和等级）
   ├─ 初始化战斗状态
   └─ 开始战斗日志

2. 回合循环
   ├─ 玩家回合
   │   ├─ 根据策略选择行动
   │   ├─ 执行技能/攻击
   │   ├─ 计算伤害/治疗
   │   └─ 应用效果（Buff/Debuff）
   │
   ├─ 敌人回合
   │   ├─ 根据AI选择行动
   │   ├─ 执行技能/攻击
   │   ├─ 计算伤害
   │   └─ 应用效果
   │
   └─ 回合结束处理
       ├─ Buff/Debuff倒计时
       ├─ DOT/HOT效果
       └─ 资源恢复

3. 胜负判定
   ├─ 检查角色状态（是否全部死亡）
   ├─ 检查敌人状态（是否全部死亡）
   └─ 决定战斗结果

4. 战斗结算
   ├─ 计算奖励（经验、金币）
   ├─ 处理掉落（装备、材料）
   ├─ 更新角色数据
   └─ 记录战斗统计
```

---

## 单角色战斗

### 战斗初始化

```go
// 单角色战斗初始化
type SingleCharacterBattle struct {
    Character *Character
    Enemies   []*Monster
    Round     int
    IsActive  bool
}
```

### 回合流程

```
回合开始
    ↓
角色行动（根据策略）
    ├─ 选择技能
    ├─ 选择目标
    └─ 执行行动
    ↓
伤害/治疗计算
    ├─ 基础伤害计算
    ├─ 防御减伤
    ├─ 暴击判定
    └─ 最终伤害
    ↓
应用效果
    ├─ 伤害/治疗
    ├─ Buff/Debuff
    └─ 状态更新
    ↓
敌人行动（根据AI）
    ├─ 选择技能
    ├─ 选择目标（通常是角色）
    └─ 执行行动
    ↓
伤害计算（同上）
    ↓
回合结束处理
    ├─ Buff/Debuff倒计时
    ├─ DOT/HOT效果
    └─ 资源恢复
    ↓
检查胜负
    ├─ 角色死亡？→ 失败
    └─ 敌人全部死亡？→ 胜利
```

---

## 多角色战斗

### 队伍战斗初始化

```go
// 队伍战斗初始化
type TeamBattle struct {
    Team    []*Character  // 最多5个角色
    Enemies []*Monster
    Round   int
    IsActive bool
}
```

### 队伍回合流程

```
回合开始
    ↓
按速度排序（角色+敌人）
    ↓
依次行动
    ├─ 角色1行动
    │   ├─ 选择技能
    │   ├─ 选择目标（敌人或队友）
    │   └─ 执行行动
    │
    ├─ 角色2行动
    │   └─ ...
    │
    ├─ 敌人1行动
    │   ├─ 根据AI选择目标（通常是仇恨最高）
    │   └─ 执行行动
    │
    └─ 敌人2行动
        └─ ...
    ↓
回合结束处理
    ├─ Buff/Debuff倒计时
    ├─ DOT/HOT效果
    └─ 资源恢复
    ↓
检查胜负
    ├─ 所有角色死亡？→ 失败
    └─ 所有敌人死亡？→ 胜利
```

### 队伍协同

#### 1. 仇恨系统

- **仇恨计算**: 伤害、治疗、嘲讽技能产生仇恨
- **目标选择**: 怪物优先攻击仇恨最高的角色
- **仇恨转移**: 使用嘲讽技能可以强制转移仇恨

#### 2. 角色定位

- **坦克**: 高防御，高仇恨，吸收伤害
- **治疗**: 低仇恨，优先治疗低血量队友
- **DPS**: 高伤害，中等仇恨，优先击杀敌人

#### 3. 协同技能

- **增益技能**: 为队友提供Buff
- **减益技能**: 为敌人提供Debuff
- **AOE技能**: 攻击多个敌人
- **治疗技能**: 治疗队友

---

## 回合机制

### 行动顺序

#### 速度值系统

每个角色和怪物都有速度值，决定行动顺序：

```
速度值 = 基础速度 + 敏捷加成 + 装备加成 + Buff加成
```

#### 排序规则

1. **速度值高的先行动**
2. **速度值相同时，角色优先于怪物**
3. **同类型速度相同时，随机排序**

### 行动类型

#### 1. 普通攻击

- **消耗**: 无（或少量资源）
- **伤害**: 基础攻击力
- **冷却**: 无

#### 2. 技能使用

- **消耗**: 资源（怒气/法力/能量）
- **伤害/效果**: 根据技能配置
- **冷却**: 根据技能配置

#### 3. 防御

- **消耗**: 无
- **效果**: 减少受到的伤害
- **冷却**: 无

#### 4. 等待

- **消耗**: 无
- **效果**: 跳过本回合，恢复资源
- **冷却**: 无

### 资源系统

#### 资源类型

| 资源类型 | 获取方式 | 消耗方式 | 恢复速度 |
|---------|---------|---------|---------|
| **怒气** (Rage) | 攻击/受击获得 | 技能消耗 | 每回合+5-10 |
| **法力** (Mana) | 回合恢复 | 技能消耗 | 每回合+10-20 |
| **能量** (Energy) | 回合恢复 | 技能消耗 | 每回合+20-30 |

#### 资源恢复

```
每回合恢复 = 基础恢复 + 精神加成 + 装备加成
```

---

## 伤害计算

### 伤害计算流程

```
1. 基础伤害计算
   基础伤害 = 攻击力 × 技能系数

2. 防御减伤计算
   减伤率 = 防御 / (防御 + 100)
   减伤后伤害 = 基础伤害 × (1 - 减伤率)
   减伤上限: 75%

3. 暴击判定
   IF 随机数 < 暴击率 THEN
       最终伤害 = 减伤后伤害 × 暴击伤害倍率
   ELSE
       最终伤害 = 减伤后伤害

4. 闪避判定
   IF 随机数 < 闪避率 THEN
       最终伤害 = 0 (闪避)
   END IF

5. 最终伤害
   最终伤害 = max(1, 最终伤害)  // 至少造成1点伤害
```

### 伤害类型

#### 1. 物理伤害

- **来源**: 物理攻击力
- **减伤**: 物理防御
- **暴击**: 物理暴击率

#### 2. 法术伤害

- **来源**: 法术攻击力
- **减伤**: 法术防御
- **暴击**: 法术暴击率

#### 3. 元素伤害

- **类型**: 火焰、冰霜、暗影、神圣、自然
- **来源**: 技能或装备
- **减伤**: 对应元素抗性


### 治疗计算

```
基础治疗 = 治疗力 × 技能系数
最终治疗 = 基础治疗 × (1 + 治疗加成%)
```

---

## 胜负判定

### 胜利条件

1. **所有敌人死亡**: 战斗胜利
2. **Boss血量归零**: Boss战胜利

### 失败条件

1. **所有角色死亡**: 战斗失败
2. **玩家主动逃跑**: 战斗失败（可选）

### 判定时机

- **每回合结束后**: 检查是否有角色或敌人全部死亡
- **即时判定**: 角色或敌人死亡时立即检查

### 战斗结果

```go
type BattleResult struct {
    IsVictory    bool
    IsDefeat     bool
    ExpGained    int
    GoldGained   int
    ItemsDropped []Item
    BattleRounds int
    Duration     time.Duration
}
```

---

## 战斗日志

### 日志类型

#### 1. 战斗日志 (Combat)

- 攻击、伤害、治疗等战斗信息
- 格式: `[战斗] 角色A 对 敌人B 造成 50 点伤害`

#### 2. 技能日志 (Skill)

- 技能使用信息
- 格式: `[技能] 角色A 使用了 英勇打击`

#### 3. 效果日志 (Effect)

- Buff/Debuff效果
- 格式: `[效果] 角色A 获得了 战斗怒吼 效果`

#### 4. 系统日志 (System)

- 战斗开始、结束、胜负等信息
- 格式: `[系统] 战斗开始` / `[系统] 战斗胜利`

### 日志格式

```go
type BattleLog struct {
    ID        int
    Message   string
    LogType   string  // combat/skill/effect/system
    Source    string  // 来源（角色/怪物名称）
    Target    string  // 目标（角色/怪物名称）
    Value     int     // 数值（伤害/治疗等）
    Color     string  // 颜色（用于前端显示）
    DamageType string // 伤害类型
    CreatedAt time.Time
}
```

---

## 战斗状态管理

### 战斗会话

```go
type BattleSession struct {
    UserID          int
    IsRunning       bool
    CurrentZone     *Zone
    CurrentEnemies  []*Monster
    Team            []*Character
    BattleLogs      []BattleLog
    BattleCount     int
    SessionKills    int
    SessionGold     int
    SessionExp      int
    StartedAt       time.Time
    CurrentTurnIndex int  // -1=玩家回合，>=0=敌人索引
}
```

### 状态转换

```
空闲 → 战斗初始化 → 战斗中 → 战斗结束 → 空闲
  ↑                                    ↓
  └────────────────────────────────────┘
```

---

## 性能优化

### 1. 战斗数据缓存

- 角色和怪物数据在战斗开始时加载到内存
- 避免频繁数据库查询

### 2. 批量更新

- 战斗结束后批量更新角色数据
- 减少数据库写入次数

### 3. 异步处理

- 战斗日志异步写入
- 统计数据异步保存

---

## 总结

### 设计亮点

1. **支持单角色和多角色**: 灵活的战斗模式
2. **清晰的回合机制**: 速度值决定行动顺序
3. **精确的伤害计算**: 考虑防御、暴击、闪避
4. **公平的胜负判定**: 明确的胜利和失败条件

### 后续扩展

- [ ] 战斗回放系统
- [ ] 战斗加速功能
- [ ] PVP战斗系统
- [ ] 战斗录像功能

---

**文档版本**: v1.0  
**最后更新**: 2025年


