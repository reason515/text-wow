# 地图系统设计文档

> 📌 **设计理念**: 地图是玩家挂机战斗的核心场所，通过区域选择、解锁机制和收益倍率，为玩家提供策略性的挂机选择

> 📌 **说明**: 本文档描述地图/区域系统设计。详细的系统架构请参考 [系统架构文档](./architecture.md)

---

## 📋 设计概览

### 核心功能

地图系统是放置类游戏的核心机制之一，玩家通过选择不同的区域来：
- 🎯 **选择难度**：不同等级范围的区域
- 💰 **优化收益**：不同倍率的经验/金币/掉落
- ⚔️ **PVP竞争**：争夺地图控制权
- 🔓 **探索解锁**：逐步解锁新区域
- 🗺️ **非线性探索**：同一等级有多个地图可选，自由选择升级路径

### 非线性地图设计

> 📌 **核心理念**: 玩家不应该被强制按照固定路线升级，而是可以根据自己的策略和偏好选择不同的地图

**设计特点**：
- ✅ **等级重叠**：同一等级范围有多个地图可选
- ✅ **多路径选择**：玩家可以选择不同的升级路线
- ✅ **策略性选择**：根据收益、难度、PVP风险等因素选择
- ✅ **阵营区分**：联盟/部落有不同的地图选择
- ✅ **PVP可选**：玩家可以选择安全区域或高风险高回报的PVP区域

**示例**：
- 15级玩家可以选择：西部荒野（联盟安全区）、赤脊山（联盟前线）、贫瘠之地（部落安全区）、石爪山脉（部落前线）、暮色森林（PVP区域）
- 每个选择都有不同的风险和收益

### 玩家决策点

区域选择是玩家的重要决策点之一：

| 决策类型 | 说明 | 示例 |
|---------|------|-----|
| **区域选择** | 去哪个地图挂机 | 难度/收益权衡 |
| **等级匹配** | 选择适合当前等级的区域 | 15级有5个地图可选 |
| **阵营限制** | 考虑阵营限制 | 联盟去联盟区域 |
| **收益优化** | 选择高倍率区域 | 后期去燃烧平原 |
| **风险偏好** | 选择安全区还是PVP区 | 安全挂机 vs 高风险高回报 |
| **升级路径** | 选择不同的升级路线 | 快速升级 vs 稳定收益 |

---

## 🗄️ 数据库设计

### zones - 区域配置表

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | VARCHAR(32) | PRIMARY KEY | 区域ID |
| name | VARCHAR(64) | NOT NULL | 区域名称 |
| description | TEXT | | 描述 |
| min_level | INTEGER | DEFAULT 1 | 最低等级 |
| max_level | INTEGER | DEFAULT 60 | 最高等级 |
| faction | VARCHAR(16) | | 阵营限制 (alliance/horde/neutral) |
| parent_zone_id | VARCHAR(32) | | 父区域（支持区域层级） |
| exp_modifier | REAL | DEFAULT 1.0 | 经验倍率 |
| gold_modifier | REAL | DEFAULT 1.0 | 金币倍率 |
| drop_modifier | REAL | DEFAULT 1.0 | 掉落倍率 |
| is_dungeon | INTEGER | DEFAULT 0 | 是否副本 (0=普通区域, 1=副本) |
| unlock_condition | TEXT | | 解锁条件(JSON) |

```sql
CREATE TABLE zones (
    id VARCHAR(32) PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    description TEXT,
    min_level INTEGER DEFAULT 1,
    max_level INTEGER DEFAULT 60,
    faction VARCHAR(16),
    parent_zone_id VARCHAR(32),
    exp_modifier REAL DEFAULT 1.0,
    gold_modifier REAL DEFAULT 1.0,
    drop_modifier REAL DEFAULT 1.0,
    is_dungeon INTEGER DEFAULT 0,
    unlock_condition TEXT,              -- 已废弃，保留用于兼容
    unlock_zone_id VARCHAR(32),         -- 需要探索的前置地图ID
    required_exploration INTEGER DEFAULT 0, -- 解锁所需探索度
    FOREIGN KEY (parent_zone_id) REFERENCES zones(id),
    FOREIGN KEY (unlock_zone_id) REFERENCES zones(id)
);

CREATE TABLE user_zone_exploration (
    user_id INTEGER NOT NULL,
    zone_id VARCHAR(32) NOT NULL,
    exploration INTEGER DEFAULT 0,       -- 当前探索度
    kills INTEGER DEFAULT 0,            -- 在该地图的击杀数
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, zone_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (zone_id) REFERENCES zones(id) ON DELETE CASCADE
);
```

### 字段说明

#### 等级限制
- **min_level**: 进入该区域的最低等级要求
- **max_level**: 该区域怪物的最高等级（超过此等级收益会衰减）

#### 阵营限制
- **faction**: 
  - `alliance`: 仅联盟玩家可进入
  - `horde`: 仅部落玩家可进入
  - `NULL`: 中立区域，所有玩家可进入

#### 收益倍率
- **exp_modifier**: 经验值倍率（1.0 = 100%，1.5 = 150%）
- **gold_modifier**: 金币倍率
- **drop_modifier**: 掉落倍率

#### 区域层级
- **parent_zone_id**: 支持区域层级关系
  - 例如：副本可以关联到父区域
  - 用于区域导航和UI展示

#### 解锁条件
- **unlock_condition**: JSON格式，支持多种解锁条件
  ```json
  {
    "type": "level",
    "value": 10
  }
  ```
  或
  ```json
  {
    "type": "zone_complete",
    "zone_id": "elwynn",
    "kills": 100
  }
  ```

---

## 🗺️ 区域分类体系

### 区域类型划分

地图按照**联盟区域**、**部落区域**、**PVP/中立区域**三大类进行划分：

#### 1. 联盟区域 (faction = 'alliance')
- 仅联盟玩家可进入
- 安全区域，无PVP风险
- 适合联盟玩家安心挂机
- 怪物以联盟敌对势力为主

#### 2. 部落区域 (faction = 'horde')
- 仅部落玩家可进入
- 安全区域，无PVP风险
- 适合部落玩家安心挂机
- 怪物以部落敌对势力为主

#### 3. PVP/中立区域 (faction = NULL)
- 所有阵营玩家可进入
- **PVP风险区域**，可能遭遇敌对阵营玩家
- 高风险高回报，收益倍率更高
- 支持地图控制权争夺
- 怪物以中立或双方敌对势力为主

---

## 🗺️ 区域数据

### 联盟区域

| 区域ID | 名称 | 等级范围 | 经验倍率 | 金币倍率 | 描述 |
|--------|------|---------|---------|---------|------|
| elwynn | 艾尔文森林 | 1-10 | 1.0 | 1.0 | 人类王国暴风城外的宁静森林，适合新手冒险者 |
| westfall | 西部荒野 | 10-20 | 1.1 | 1.1 | 曾经肥沃的农田，如今被迪菲亚兄弟会占领 |
| redridge | 赤脊山 | 15-25 | 1.15 | 1.15 | 被黑石兽人威胁的山脉，联盟的前线 |
| loch_modan | 洛克莫丹 | 10-20 | 1.1 | 1.1 | 矮人的家园，群山环绕的美丽山谷 |
| dun_morogh | 丹莫罗 | 1-10 | 1.0 | 1.0 | 矮人和侏儒的雪域家园 |
| teldrassil | 泰达希尔 | 1-10 | 1.0 | 1.0 | 暗夜精灵的世界树，神秘的森林 |
| darkshore | 黑海岸 | 10-20 | 1.1 | 1.1 | 被诅咒的海岸线，暗夜精灵的领地 |
| wetlands | 湿地 | 20-30 | 1.2 | 1.2 | 泥泞的沼泽地，连接南北的交通要道 |
| arathi | 阿拉希高地 | 30-40 | 1.3 | 1.3 | 联盟与部落争夺的战略要地 |
| hillsbrad | 希尔斯布莱德丘陵 | 20-30 | 1.2 | 1.2 | 联盟的农业区，经常遭受部落袭击 |

### 部落区域

| 区域ID | 名称 | 等级范围 | 经验倍率 | 金币倍率 | 描述 |
|--------|------|---------|---------|---------|------|
| durotar | 杜隆塔尔 | 1-10 | 1.0 | 1.0 | 兽人的家园，炎热干燥的红色大地 |
| barrens | 贫瘠之地 | 10-25 | 1.1 | 1.1 | 广袤的草原，危险与机遇并存 |
| stonetalon | 石爪山脉 | 15-25 | 1.15 | 1.15 | 被联盟威胁的山脉，部落的防御前线 |
| thousand_needles | 千针石林 | 25-35 | 1.25 | 1.25 | 奇特的石柱群，半人马的家园 |
| mulgore | 莫高雷 | 1-10 | 1.0 | 1.0 | 牛头人的家园，广阔的草原 |
| tirisfal | 提瑞斯法林地 | 1-10 | 1.0 | 1.0 | 被遗忘者的家园，阴森的森林 |
| silverpine | 银松森林 | 10-20 | 1.1 | 1.1 | 被诅咒的森林，被遗忘者的领地 |
| ashenvale | 灰谷 | 18-30 | 1.2 | 1.2 | 暗夜精灵与部落的冲突前线 |
| desolace | 凄凉之地 | 30-40 | 1.3 | 1.3 | 荒凉的废土，半人马和恶魔的领地 |
| tarren_mill | 塔伦米尔 | 20-30 | 1.2 | 1.2 | 部落的据点，与联盟的希尔斯布莱德对峙 |

### PVP/中立区域

| 区域ID | 名称 | 等级范围 | 经验倍率 | 金币倍率 | 描述 |
|--------|------|---------|---------|---------|------|
| duskwood | 暮色森林 | 20-30 | 1.2 | 1.2 | 被永恒黑暗笼罩的诡异森林，亡灵与狼人出没 |
| stranglethorn | 荆棘谷 | 30-45 | 1.3 | 1.3 | 危险的丛林，到处是食人族和野兽 |
| tanaris | 塔纳利斯 | 40-50 | 1.4 | 1.4 | 炎热的沙漠，隐藏着古老的秘密 |
| burning_steppes | 燃烧平原 | 50-60 | 1.5 | 1.5 | 被黑龙军团占领的焦土 |
| badlands | 荒芜之地 | 35-45 | 1.35 | 1.35 | 荒凉的废土，黑铁矮人的家园 |
| swamp_of_sorrows | 悲伤沼泽 | 35-45 | 1.35 | 1.35 | 被诅咒的沼泽，绿龙军团的领地 |
| dustwallow | 尘泥沼泽 | 35-45 | 1.35 | 1.35 | 泥泞的沼泽，黑龙的巢穴 |
| feralas | 菲拉斯 | 40-50 | 1.4 | 1.4 | 茂密的丛林，古精灵的遗迹 |
| ungoro | 安戈洛环形山 | 48-55 | 1.45 | 1.45 | 史前生物的乐园，充满危险 |
| felwood | 费伍德森林 | 48-55 | 1.45 | 1.45 | 被恶魔腐蚀的森林，燃烧军团的痕迹 |
| winterspring | 冬泉谷 | 55-60 | 1.5 | 1.5 | 永恒的雪域，蓝龙军团的领地 |
| silithus | 希利苏斯 | 55-60 | 1.5 | 1.5 | 沙漠中的虫巢，其拉虫人的威胁 |

### 非线性地图选择示例

#### 15级玩家的选择

**联盟玩家（3个选择）**：
- 西部荒野（10-20级，1.1x，安全，稳定收益）
- 赤脊山（15-25级，1.15x，安全，收益更高）
- 暮色森林（18-30级，1.2x，PVP风险，收益最高）

**部落玩家（3个选择）**：
- 贫瘠之地（10-25级，1.1x，安全，稳定收益）
- 石爪山脉（15-25级，1.15x，安全，收益更高）
- 暮色森林（18-30级，1.2x，PVP风险，收益最高）

**选择策略**：
- 保守玩家：选择安全区域，稳定升级
- 激进玩家：选择PVP区域，高风险高回报
- 平衡玩家：选择收益略高的安全区域

#### 20级玩家的选择

**联盟玩家（4个选择）**：
- 西部荒野（10-20级，1.1x，安全，但等级接近上限）
- 赤脊山（15-25级，1.15x，安全，收益更高）
- 湿地（18-30级，1.2x，安全，收益最高）
- 暮色森林（18-30级，1.2x，PVP风险，收益最高）

**部落玩家（4个选择）**：
- 贫瘠之地（10-25级，1.1x，安全，稳定收益）
- 石爪山脉（15-25级，1.15x，安全，收益更高）
- 灰谷（18-30级，1.2x，安全，收益最高）
- 暮色森林（18-30级，1.2x，PVP风险，收益最高）

#### 30级玩家的选择

**联盟玩家（4个选择）**：
- 湿地（18-30级，1.2x，安全，但等级接近上限）
- 希尔斯布莱德丘陵（20-30级，1.2x，安全，但等级接近上限）
- 阿拉希高地（30-40级，1.3x，安全，收益更高）
- 荆棘谷（28-45级，1.3x，PVP风险，收益最高）

**部落玩家（4个选择）**：
- 灰谷（18-30级，1.2x，安全，但等级接近上限）
- 塔伦米尔（20-30级，1.2x，安全，但等级接近上限）
- 凄凉之地（30-40级，1.3x，安全，收益更高）
- 荆棘谷（28-45级，1.3x，PVP风险，收益最高）

#### 40级玩家的选择

**所有玩家（6个选择）**：
- 荆棘谷（28-45级，1.3x，PVP风险）
- 荒芜之地（32-45级，1.35x，PVP风险，收益更高）
- 悲伤沼泽（32-45级，1.35x，PVP风险，收益更高）
- 尘泥沼泽（32-45级，1.35x，PVP风险，收益更高）
- 塔纳利斯（38-50级，1.4x，PVP风险，收益最高）
- 菲拉斯（38-50级，1.4x，PVP风险，收益最高）

**选择策略**：
- 40级玩家有6个PVP区域可选
- 可以根据自己的PVP能力和风险偏好选择
- 收益从1.3x到1.4x，差异明显

#### 50级玩家的选择

**所有玩家（5个选择）**：
- 安戈洛环形山（45-55级，1.45x，PVP风险）
- 费伍德森林（45-55级，1.45x，PVP风险）
- 燃烧平原（48-60级，1.5x，PVP风险，收益最高）
- 冬泉谷（52-60级，1.5x，PVP风险，收益最高）
- 希利苏斯（52-60级，1.5x，PVP风险，收益最高）

**选择策略**：
- 50级玩家有5个顶级PVP区域可选
- 所有区域都是PVP风险区域
- 收益从1.45x到1.5x，都是高收益区域

### 区域特点总结（按等级范围）

**1-10级（新手区）**
- 联盟：艾尔文森林、丹莫罗、泰达希尔（3选1）
- 部落：杜隆塔尔、莫高雷、提瑞斯法林地（3选1）
- 基础倍率 1.0，适合新手熟悉游戏

**10-20级（中低级）**
- 联盟：西部荒野、洛克莫丹、黑海岸（3选1）
- 部落：贫瘠之地、银松森林（2选1）
- 倍率 1.1，阵营专属区域

**15-25级（中低级重叠）**
- 联盟：赤脊山（15-25级，1.15x）
- 部落：石爪山脉（15-25级，1.15x）
- 倍率 1.15，收益略高

**18-30级（中高级）**
- 联盟：湿地、希尔斯布莱德丘陵（2选1）
- 部落：灰谷、塔伦米尔（2选1）
- PVP：暮色森林（20-30级，1.2x）
- 倍率 1.2，开始出现PVP区域

**25-35级（中高级重叠）**
- 部落：千针石林（25-35级，1.25x）
- 倍率 1.25，部落专属

**30-45级（高级）**
- 联盟：阿拉希高地（30-40级，1.3x）
- 部落：凄凉之地（30-40级，1.3x）
- PVP：荆棘谷（30-45级，1.3x）
- 倍率 1.3，PVP风险增加

**35-50级（高级重叠）**
- PVP：荒芜之地、悲伤沼泽、尘泥沼泽（35-45级，1.35x，3选1）
- PVP：塔纳利斯、菲拉斯（40-50级，1.4x，2选1）
- 倍率 1.35-1.4，多个PVP选择

**48-60级（顶级）**
- PVP：安戈洛环形山、费伍德森林（48-55级，1.45x，2选1）
- PVP：燃烧平原（50-60级，1.5x）
- PVP：冬泉谷、希利苏斯（55-60级，1.5x，2选1）
- 倍率 1.45-1.5，最高收益但PVP风险极高

### 区域倍率递增规律

```
新手区:  1.0x (基础)
中低级:  1.1-1.15x (+10-15%)
中高级:  1.2-1.3x (+20-30%)
高级区:  1.35-1.5x (+35-50%)
```

### 非线性设计优势

1. **玩家选择自由**：同一等级有多个地图可选，玩家可以根据自己的策略选择
2. **风险收益权衡**：安全区域 vs PVP区域，玩家可以自由选择
3. **阵营差异化**：联盟和部落有不同的地图选择，增加阵营特色
4. **升级路径多样化**：玩家可以选择快速升级路线或稳定收益路线
5. **重玩价值**：不同角色可以选择不同的升级路径，增加游戏深度

---

## 🔓 区域解锁机制（探索度系统）

### 核心机制

**探索度系统**替代了原有的等级解锁机制，玩家通过在地图中击杀怪物来提升探索度，探索度达到要求后即可解锁后续地图。

### 探索度获取

- **击杀怪物**：每击杀一个怪物获得 **1点探索度**
- **探索度累积**：探索度按地图分别计算，每个地图的探索度独立累积
- **永久记录**：探索度永久保存，不会重置

### 解锁条件

地图解锁需要满足以下条件：

1. **探索度要求**：
   - 如果地图设置了 `unlock_zone_id` 和 `required_exploration`，需要在前置地图达到指定探索度
   - 例如：`westfall` 需要 `elwynn` 探索度达到 100

2. **最低等级要求**：
   - 仍然保留 `min_level` 作为最低等级限制
   - 即使探索度足够，等级不足也无法进入

3. **阵营限制**：
   - 阵营匹配（如果有阵营限制）

### 数据库设计

#### zones 表新增字段

| 字段 | 类型 | 说明 |
|-----|------|-----|
| unlock_zone_id | VARCHAR(32) | 需要探索的前置地图ID（NULL表示初始地图） |
| required_exploration | INTEGER | 解锁所需探索度（0表示无需探索度解锁） |

#### user_zone_exploration 表

| 字段 | 类型 | 说明 |
|-----|------|-----|
| user_id | INTEGER | 用户ID |
| zone_id | VARCHAR(32) | 地图ID |
| exploration | INTEGER | 当前探索度 |
| kills | INTEGER | 在该地图的击杀数 |
| last_updated | DATETIME | 最后更新时间 |

### 解锁流程

```
1. 玩家在初始地图（如 elwynn）击杀怪物
   ↓
2. 每击杀1个怪物，该地图探索度 +1
   ↓
3. 探索度达到要求（如 100）后，解锁后续地图（如 westfall）
   ↓
4. 玩家可以切换到新解锁的地图
```

### 解锁状态检查

玩家需要满足以下条件才能进入区域：
1. ✅ 探索度 >= required_exploration（如果设置了前置地图）
2. ✅ 等级 >= min_level（最低等级要求）
3. ✅ 阵营匹配（如果有阵营限制）
4. ✅ 区域已启用

---

## 🔄 区域切换机制

### 切换流程

```
1. 玩家选择目标区域
   ↓
2. 检查解锁条件
   ├─ 未解锁 → 显示解锁条件，禁止切换
   └─ 已解锁 → 继续
   ↓
3. 检查等级限制
   ├─ 等级不足 → 提示等级要求
   └─ 等级满足 → 继续
   ↓
4. 检查阵营限制
   ├─ 阵营不匹配 → 提示阵营限制
   └─ 阵营匹配 → 继续
   ↓
5. 切换区域
   ├─ 停止当前战斗（如果正在战斗）
   ├─ 更新当前区域
   └─ 返回新区域信息
```

### API 接口

#### ChangeZone - 切换区域

**请求**
```json
POST /api/battle/change-zone
{
  "zoneId": "westfall"
}
```

**响应**
```json
{
  "success": true,
  "data": {
    "status": {
      "currentZone": {
        "id": "westfall",
        "name": "西部荒野",
        "minLevel": 10,
        "maxLevel": 20,
        "expMulti": 1.1,
        "goldMulti": 1.1
      }
    },
    "logs": [...]
  }
}
```

#### GetZonesWithMonsters - 获取区域列表

**请求**
```
GET /api/battle/zones
```

**响应**
```json
{
  "success": true,
  "data": [
    {
      "id": "elwynn",
      "name": "艾尔文森林",
      "description": "...",
      "minLevel": 1,
      "maxLevel": 10,
      "faction": "alliance",
      "expMulti": 1.0,
      "goldMulti": 1.0,
      "monsters": [...]
    },
    ...
  ]
}
```

### 切换限制

**当前设计**：无冷却时间，可随时切换

**未来可考虑**：
- 切换冷却时间（如30秒）
- 战斗中禁止切换
- 切换消耗资源（如金币）

---

## ⚔️ PVP 与地图控制机制

### 地图阵营控制表

#### zone_faction_control - 地图阵营控制表

> 📌 **地图归属**: 记录每个地图的阵营控制状态和效率加成

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| zone_id | VARCHAR(32) | PRIMARY KEY FK | 区域ID |
| controlling_faction | VARCHAR(16) | | 当前控制阵营: alliance/horde/neutral |
| alliance_wins | INTEGER | DEFAULT 0 | 联盟近期胜场 |
| horde_wins | INTEGER | DEFAULT 0 | 部落近期胜场 |
| alliance_win_rate | REAL | DEFAULT 0.5 | 联盟胜率 |
| control_score | INTEGER | DEFAULT 0 | 控制积分 (正=联盟, 负=部落) |
| efficiency_bonus | REAL | DEFAULT 0 | 控制方效率加成 (0.0-0.2) |
| efficiency_penalty | REAL | DEFAULT 0 | 被控方效率惩罚 (0.0-0.1) |
| last_battle_at | DATETIME | | 最后一次战斗时间 |
| stats_reset_at | DATETIME | | 统计重置时间 (每周) |

```sql
CREATE TABLE zone_faction_control (
    zone_id VARCHAR(32) PRIMARY KEY,
    controlling_faction VARCHAR(16) DEFAULT 'neutral',
    alliance_wins INTEGER DEFAULT 0,
    horde_wins INTEGER DEFAULT 0,
    alliance_win_rate REAL DEFAULT 0.5,
    control_score INTEGER DEFAULT 0,
    efficiency_bonus REAL DEFAULT 0,
    efficiency_penalty REAL DEFAULT 0,
    last_battle_at DATETIME,
    stats_reset_at DATETIME,
    FOREIGN KEY (zone_id) REFERENCES zones(id)
);
```

### 控制权计算规则

```
控制积分变化:
  - 联盟胜利: +1 分
  - 部落胜利: -1 分
  - 积分范围: -100 ~ +100

控制权判定:
  - 积分 >= +20: 联盟控制
  - 积分 <= -20: 部落控制
  - -20 < 积分 < +20: 中立/争夺中

效率加成计算:
  - 控制方: +效率加成 (最高+20%)
  - 被控方: -效率惩罚 (最高-10%)
  - 加成比例 = |积分| / 100 × 最大加成
```

### PVP 遭遇机制

**核心机制**：
- 同一地图的敌对阵营玩家随机匹配
- 触发自动PVP战斗
- 使用玩家设置的战斗策略，自动化对决
- 胜负影响地图控制权

**效率影响**：
- 控制方获得挂机效率提升（最高+20%）
- 被控方效率降低（最高-10%）
- 激励玩家提升战力和优化策略来争夺地图控制权

---

## 💬 聊天系统集成

### 区域频道

- **频道类型**: `zone`
- **范围**: 当前区域内同阵营玩家
- **颜色**: 🟠 橙色
- **用途**: 同区域玩家交流、组队、分享信息

### 在线状态

- 记录玩家当前所在区域
- 用于显示"同区域在线玩家"
- 支持区域筛选

---

## 🎨 UI 设计建议

### 地图选择界面

```
╔══════════════════════════════════════════════════════════════╗
║  地图选择                                    [当前: 艾尔文森林] ║
╠══════════════════════════════════════════════════════════════╣
║                                                              ║
║  【新手区域】                                                ║
║  ┌──────────────────────────────────────────────────────┐  ║
║  │ [✓] 艾尔文森林 (联盟)                                 │  ║
║  │     等级: 1-10 | 倍率: 1.0x | 当前区域               │  ║
║  │     描述: 人类王国暴风城外的宁静森林...                │  ║
║  └──────────────────────────────────────────────────────┘  ║
║  ┌──────────────────────────────────────────────────────┐  ║
║  │ [✓] 杜隆塔尔 (部落)                                     │  ║
║  │     等级: 1-10 | 倍率: 1.0x                            │  ║
║  └──────────────────────────────────────────────────────┘  ║
║                                                              ║
║  【中低级区域】                                              ║
║  ┌──────────────────────────────────────────────────────┐  ║
║  │ [✓] 西部荒野 (联盟)                                     │  ║
║  │     等级: 10-20 | 倍率: 1.1x | 需要等级10              │  ║
║  └──────────────────────────────────────────────────────┘  ║
║  ┌──────────────────────────────────────────────────────┐  ║
║  │ [🔒] 燃烧平原 (中立)                                    │  ║
║  │     等级: 50-60 | 倍率: 1.5x | 需要等级50              │  ║
║  │     ⚠️ 等级不足 (当前: 15级)                            │  ║
║  └──────────────────────────────────────────────────────┘  ║
║                                                              ║
║  [切换到此区域]                                              ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
```

### 区域信息展示

- **当前区域**: 高亮显示
- **解锁状态**: 
  - ✅ 已解锁可进入
  - 🔒 未解锁（显示解锁条件）
- **等级匹配**: 
  - 绿色：适合当前等级
  - 黄色：等级偏低或偏高
  - 红色：等级严重不匹配
- **阵营限制**: 显示阵营图标
- **收益倍率**: 显示经验/金币倍率

---

## 📊 收益计算

### 经验值计算

```
最终经验 = 怪物基础经验 × (1 + 等级差 × 0.1) × 区域经验倍率 × 阵营控制加成 × 种族加成

其中：
- 等级差 = 怪物等级 - 角色等级（正数有加成，负数有惩罚）
- 区域经验倍率 = zones.exp_modifier
- 阵营控制加成 = 1.0 + efficiency_bonus（控制方）或 1.0 - efficiency_penalty（被控方）
- 种族加成 = 人类 +10%（如果有）
```

### 金币计算

```
最终金币 = 怪物基础金币 × 区域金币倍率 × 阵营控制加成
```

### 掉落计算

```
掉落倍率 = 区域掉落倍率 × 阵营控制加成
```

---

## 🎲 怪物生成机制（加权随机）

### 核心机制

怪物生成使用**加权随机算法**，根据 `spawn_weight`（生成权重）控制不同怪物的出现概率。

### 权重系统

| 怪物类型 | 典型权重 | 出现概率 | 说明 |
|---------|---------|---------|------|
| **normal** (普通) | 30-100 | 高 | 最常见的怪物，出现频率最高 |
| **elite** (精英) | 5-10 | 低 | 稀有怪物，出现频率低但奖励更高 |
| **boss** (首领) | 1-3 | 极低 | 非常稀有，出现频率极低但奖励丰厚 |

### 权重计算

**概率计算公式**：
```
怪物出现概率 = 怪物权重 / 所有怪物权重总和
```

**示例**（艾尔文森林）：
- 森林狼 (normal, weight=100): 概率 ≈ 100/500 = 20%
- 小野猪 (normal, weight=100): 概率 ≈ 100/500 = 20%
- 狗头人矿工 (normal, weight=80): 概率 ≈ 80/500 = 16%
- 霍格 (elite, weight=5): 概率 ≈ 5/500 = 1%

### 实现细节

1. **加权随机算法**：
   - 计算所有怪物的权重总和
   - 生成 0 到总权重之间的随机数
   - 遍历怪物列表，累加权重，找到对应的怪物

2. **权重保护**：
   - 如果权重 ≤ 0，自动设置为 1（避免除零错误）
   - 如果所有权重都是 0，回退到简单随机选择

3. **稀有度设计**：
   - 普通怪物：高权重（30-100），常见
   - 精英怪物：低权重（5-10），稀有，但奖励更高
   - 首领怪物：极低权重（1-3），非常稀有，奖励丰厚

### 设计优势

- ✅ **稀有度控制**：通过权重精确控制稀有怪物的出现频率
- ✅ **奖励平衡**：稀有怪物出现少，但奖励更高，保持游戏平衡
- ✅ **玩家体验**：遇到稀有怪物时更有惊喜感
- ✅ **可配置性**：通过调整权重即可调整怪物出现频率

---

## 🔮 未来扩展

### 副本系统

- **is_dungeon = 1**: 标记为副本
- 副本特点：
  - 固定怪物配置
  - 更高收益倍率
  - 需要组队或更高战力
  - 有Boss战

### 区域事件

- 限时双倍经验区域
- 特殊怪物刷新
- 区域任务

### 区域探索度

- 记录玩家在各区域的探索进度
- 解锁区域成就
- 区域专属奖励

### 区域推荐系统

- 根据玩家等级和战力推荐最优区域
- 显示收益预估
- 显示难度评估

---

## 📎 相关文档

- [数据库设计](database_design.md) - 完整的数据库架构
- [游戏机制设计](game_mechanics.md) - 战斗、属性等核心机制
- [作战策略系统设计](strategy_design.md) - 战斗策略配置

---

## 🎯 非线性设计优势

### 1. 玩家选择自由

**同一等级多个选择**：
- 15级：联盟3选1，部落3选1
- 20级：联盟4选1，部落4选1
- 30级：联盟4选1，部落4选1
- 40级：所有玩家6选1
- 50级：所有玩家5选1

### 2. 风险收益权衡

**安全区域 vs PVP区域**：
- 安全区域：无PVP风险，收益稳定
- PVP区域：有PVP风险，但收益更高（+10-20%）
- 玩家可以根据自己的PVP能力和风险偏好选择

### 3. 升级路径多样化

**快速升级路线**：
- 选择收益最高的PVP区域
- 高风险高回报
- 适合有PVP能力的玩家

**稳定收益路线**：
- 选择安全区域
- 稳定升级，无PVP风险
- 适合休闲玩家

**平衡路线**：
- 选择收益略高的安全区域
- 在安全和收益之间平衡
- 适合大多数玩家

### 4. 阵营差异化

**联盟和部落有不同的地图选择**：
- 联盟：人类、矮人、暗夜精灵相关地图
- 部落：兽人、牛头人、被遗忘者相关地图
- 增加阵营特色和代入感

### 5. 重玩价值

**不同角色可以选择不同的升级路径**：
- 第一次：选择安全区域，稳定升级
- 第二次：选择PVP区域，挑战高收益
- 第三次：尝试不同的地图组合
- 增加游戏深度和重玩价值

---

## ❓ 待讨论问题

1. **区域切换冷却**: 是否需要添加切换冷却时间？
2. **战斗中切换**: 是否允许在战斗中切换区域？
3. **区域数量**: 当前33个区域是否足够？
4. **副本设计**: 副本与普通区域的具体区别？
5. **离线收益**: 离线时是否按当前区域计算收益？
6. **区域推荐**: 是否需要自动推荐最优区域？
7. **区域层级**: 父子区域关系的具体用途？
8. **解锁条件**: 解锁条件的复杂度和类型范围？
9. **非线性平衡**: 如何确保不同路径的平衡性？
10. **地图推荐系统**: 是否需要根据玩家等级和偏好推荐地图？

---

*最后更新: 2025-01-XX*

